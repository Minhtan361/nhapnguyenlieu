<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="icon" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon.ico" type="image/x-icon">

<link rel="icon" type="image/png" sizes="16x16" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="57x57" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-57x57.png">
<link rel="icon" type="image/png" sizes="60x60" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-60x60.png">
<link rel="icon" type="image/png" sizes="72x72" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-72x72.png">
<link rel="icon" type="image/png" sizes="76x76" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-76x76.png">
<link rel="icon" type="image/png" sizes="96x96" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="114x114" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-114x114.png">
<link rel="icon" type="image/png" sizes="120x120" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-120x120.png">
<link rel="icon" type="image/png" sizes="144x144" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-144x144.png">
<link rel="icon" type="image/png" sizes="152x152" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-152x152.png">
<link rel="icon" type="image/png" sizes="180x180" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-192x192.png">
<link rel="icon" type="image/png" sizes="256x256" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-256x256.png">
<link rel="icon" type="image/png" sizes="384x384" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-384x384.png">
<link rel="icon" type="image/png" sizes="512x512" href="https://minhtan361.github.io/nhapnguyenlieu/logo/favicon-512x512.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhtan361</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a3d;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            padding-top: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s;
            margin-bottom: 20px;
            border: none;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-top-left-radius: 12px !important;
            border-top-right-radius: 12px !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        
        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .highlight {
            background-color: #fff8e1;
        }
        
        .section-title {
            border-left: 5px solid var(--primary-color);
            padding-left: 15px;
            margin: 25px 0 20px;
            color: var(--dark-color);
            font-size: 1.15rem;
            font-weight: 600;
        }

        .section-title:first-child {
            margin-top: 5px;
        }
        
        .stats-box {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stats-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stats-label {
            font-size: 1rem;
            color: #6c757d;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .food-item {
            margin-bottom: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .food-item label {
            grid-column: 1 / 4;
            font-weight: 500;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }
        
        .price-input {
            position: relative;
        }
        
        .price-input::after {
            content: "VND";
            position: absolute;
            right: 10px;
            top: 12px;
            color: #6c757d;
            pointer-events: none; /* Quan tr·ªçng ƒë·ªÉ kh√¥ng ngƒÉn c·∫£n input */
        }
        
        .sync-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-online {
            background-color: #2ecc71;
        }
        
        .sync-offline {
            background-color: #e74c3c;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #e8f5e9 !important;
        }
        
        .editable-row {
            background-color: #e3f2fd !important;
        }
        
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .auth-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
        }
        
        @media (max-width: 768px) {
            .food-item {
                grid-template-columns: 1fr;
            }
            
            .food-item label {
                grid-column: 1;
            }
            
            .auth-content {
                width: 90%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="fas fa-shopping-cart me-2"></i>Nh·∫≠p Li·ªáu H·∫±ng Ng√†y</h1>
            <p class="lead">minhtan361 - THAITHAE</p>
            <div class="d-flex justify-content-center align-items-center mt-3">
                <span class="sync-status sync-online" id="syncStatus"></span>
                <small id="syncMessage">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</small>
            </div>
        </div>
        
        <div class="notification" id="notification"></div>
        
        <div class="auth-modal" id="authModal">
            <div class="auth-content">
                <h3 class="text-center mb-4">X√°c th·ª±c quy·ªÅn qu·∫£n tr·ªã</h3>
                <div class="mb-3">
                    <label for="passwordInput" class="form-label">M·∫≠t kh·∫©u:</label>
                    <input type="password" class="form-control" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="submitPassword">X√°c nh·∫≠n</button>
                    <button class="btn btn-secondary" id="cancelAuth">H·ªßy</button>
                </div>
                <p class="text-center mt-3 text-danger" id="authError" style="display: none;">M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-day me-2"></i>Th√¥ng Tin
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="selectedDate" class="form-label">Ch·ªçn ng√†y:</label>
                            <input type="date" class="form-control" id="selectedDate" required>
                        </div>
                        
                        <h4 class="section-title">Th·ªãt</h4>
                        <div id="meatItems">
                            <div class="food-item">
                                <label class="form-label">S∆∞·ªùn cay</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="S∆∞·ªùn cay" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="S∆∞·ªùn cay" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="S∆∞·ªùn cay" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Ba r·ªçi</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="Ba r·ªçi" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="Ba r·ªçi" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="Ba r·ªçi" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">B·∫±m</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="B·∫±m" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="B·∫±m" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="B·∫±m" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Kh√°c</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="otherMeatName" placeholder="T√™n m·∫∑t h√†ng">
                                </div>
                                <input type="number" class="form-control" id="otherMeatQty" placeholder="S·ªë l∆∞·ª£ng" min="0" step="0.1">
                                <input type="number" class="form-control price-input" id="otherMeatPrice" placeholder="ƒê∆°n gi√°" min="0">
                                <button class="btn btn-outline-secondary" type="button" id="addMeatBtn">Th√™m</button>
                            </div>
                        </div>
                        
                        <div class="text-end mt-2">
                            <strong>T·ªïng ti·ªÅn Th·ªãt: </strong>
                            <span id="totalMeatAmount" class="text-primary fw-bold">0 VND</span>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary btn-lg" id="saveMeatData">
                                <i class="fas fa-drumstick-bite me-2"></i>L∆∞u th√¥ng tin Th·ªãt
                            </button>
                        </div>

                        <h4 class="section-title">H·∫£i s·∫£n</h4>
                        <div id="seafoodItems">
                            <div class="food-item">
                                <label class="form-label">T√¥m</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="T√¥m" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="T√¥m" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="T√¥m" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">M·ª±c</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="M·ª±c" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="M·ª±c" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="M·ª±c" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">S√≤ huy·∫øt</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="S√≤ huy·∫øt" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="S√≤ huy·∫øt" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="S√≤ huy·∫øt" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">B·∫°ch tu·ªôc</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="B·∫°ch tu·ªôc" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="B·∫°ch tu·ªôc" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="B·∫°ch tu·ªôc" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">B√∫n</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="B√∫n" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="B√∫n" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="B√∫n" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">ƒê·∫≠u h·ªß</label>
                                <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="ƒê·∫≠u h·ªß" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="ƒê·∫≠u h·ªß" min="0">
                                <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="ƒê·∫≠u h·ªß" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Kh√°c</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="otherSeafoodName" placeholder="T√™n m·∫∑t h√†ng">
                                </div>
                                <input type="number" class="form-control" id="otherSeafoodQty" placeholder="S·ªë l∆∞·ª£ng" min="0" step="0.1">
                                <input type="number" class="form-control price-input" id="otherSeafoodPrice" placeholder="ƒê∆°n gi√°" min="0">
                                <button class="btn btn-outline-secondary" type="button" id="addSeafoodBtn">Th√™m</button>
                            </div>
                        </div>

                        <div class="text-end mt-2">
                            <strong>T·ªïng ti·ªÅn H·∫£i s·∫£n: </strong>
                            <span id="totalSeafoodAmount" class="text-primary fw-bold">0 VND</span>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary btn-lg" id="saveSeafoodData">
                                <i class="fas fa-fish me-2"></i>L∆∞u th√¥ng tin H·∫£i s·∫£n
                            </button>
                        </div>

                        <div class="d-grid gap-2 mt-4" style="display: none;">
                            <button class="btn btn-primary btn-lg" id="saveData">
                                <i class="fas fa-save me-2"></i>L∆∞u to√†n b·ªô th√¥ng tin
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i>D·ªØ li·ªáu ƒë√£ nh·∫≠p
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="viewDate" class="form-label">Ch·ªçn ng√†y ƒë·ªÉ xem:</label>
                            <input type="date" class="form-control" id="viewDate">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="dataTable">
                                <thead>
                                    <tr>
                                        <th>M·∫∑t h√†ng</th>
                                        <th>S·ªë l∆∞·ª£ng</th>
                                        <th>ƒê∆°n gi√° (VND)</th>
                                        <th>Th√†nh ti·ªÅn (VND)</th>
                                        <th id="editColumnHeader" style="display: none;">Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                        
                        <div id="dailySummary" class="alert alert-info mt-3" style="display:none;">
                            </div>
                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-danger" id="deleteDate">
                                <i class="fas fa-trash me-2"></i>X√≥a d·ªØ li·ªáu ng√†y n√†y
                            </button>
                            <button class="btn btn-warning" id="toggleEditMode">
                                <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie me-2"></i>Th·ªëng k√™
                    </div>
                    <div class="card-body">
                        <h5 class="section-title">Th·ªëng k√™ theo th√°ng</h5>
                        <div class="mb-3">
                            <label for="monthSelector" class="form-label">Ch·ªçn th√°ng:</label>
                            <input type="month" class="form-control" id="monthSelector">
                        </div>

                        <hr>
                        
                        <h5 class="section-title">Th·ªëng k√™ theo kho·∫£ng ng√†y</h5>
                        <div class="mb-3">
                            <label for="startDateSelector" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu:</label>
                            <input type="date" class="form-control" id="startDateSelector">
                        </div>
                        <div class="mb-3">
                            <label for="endDateSelector" class="form-label">Ng√†y k·∫øt th√∫c:</label>
                            <input type="date" class="form-control" id="endDateSelector">
                        </div>
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-secondary" id="calculateDateRange">
                                <i class="fas fa-calendar-alt me-2"></i>T√≠nh t·ªïng theo kho·∫£ng ng√†y
                            </button>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalDays">0</div>
                            <div class="stats-label">S·ªë ng√†y c√≥ d·ªØ li·ªáu</div>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalMeat">0 kg</div>
                            <div class="stats-label">T·ªïng l∆∞·ª£ng th·ªãt</div>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalMeatAmountStat">0 VND</div>
                            <div class="stats-label">T·ªïng ti·ªÅn th·ªãt</div>
                        </div>
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalSeafood">0 kg</div>
                            <div class="stats-label">T·ªïng l∆∞·ª£ng h·∫£i s·∫£n</div>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalSeafoodAmountStat">0 VND</div>
                            <div class="stats-label">T·ªïng ti·ªÅn h·∫£i s·∫£n</div>
                        </div>
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalAmount">0 VND</div>
                            <div class="stats-label">T·ªïng ti·ªÅn</div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="exportExcel">
                                <i class="fas fa-file-excel me-2"></i>Xu·∫•t file Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>minhtan361 - THAITHAE &copy; 2025 - D·ªØ li·ªáu ƒë∆∞·ª£c ƒë·ªìng b·ªô th·ªùi gian th·ª±c pls ƒë·ª´ng sao ch√©p c·ªßa t√¥i </p>
        </footer>
    </div>

    <script>
        // C·∫•u h√¨nh Firebase - S·ª≠ d·ª•ng c·∫•u h√¨nh c·ªßa b·∫°n
        const firebaseConfig = {
            apiKey: "AIzaSyDOPvcf8_zKxkMAUeI56QlNPXxDtz-jaJE",
            authDomain: "nguyenlieu-9de17.firebaseapp.com",
            projectId: "nguyenlieu-9de17",
            storageBucket: "nguyenlieu-9de17.firebasestorage.app",
            messagingSenderId: "1083805342364",
            appId: "1:1083805342364:web:fd99aac7d0174ea008eb59",
            measurementId: "G-0RPVKN6M5T"
        };
        
        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Bi·∫øn to√†n c·ª•c
        let purchaseData = {};
        let unsubscribe = null;
        let isAuthenticated = false;
        let isEditMode = false;
        let currentEditingDate = null;
        
        // H√†m ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn theo ki·ªÉu Vi·ªát Nam (cho hi·ªÉn th·ªã HTML)
        function formatCurrencyVND(amount) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(amount)); // L√†m tr√≤n ƒë·ªÉ tr√°nh l·ªói s·ªë l·∫ª
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh l√† ng√†y h√¥m nay
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selectedDate').value = today;
            document.getElementById('viewDate').value = today;
            
            // H√†m hi·ªÉn th·ªã th√¥ng b√°o
            function showNotification(message, isSuccess = true) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.backgroundColor = isSuccess ? '#2ecc71' : '#e74c3c';
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
            
            // H√†m hi·ªÉn th·ªã modal x√°c th·ª±c
            function showAuthModal(callback) {
                const modal = document.getElementById('authModal');
                const errorMsg = document.getElementById('authError');
                const passwordInput = document.getElementById('passwordInput');
                
                // Reset modal
                passwordInput.value = '';
                errorMsg.style.display = 'none';
                
                // Hi·ªÉn th·ªã modal
                modal.style.display = 'flex';
                
                // X·ª≠ l√Ω s·ª± ki·ªán x√°c nh·∫≠n
                const confirmHandler = function() {
                    if (passwordInput.value === 'thaithae2025@') {
                        isAuthenticated = true;
                        modal.style.display = 'none';
                        if (callback) callback(true);
                    } else {
                        errorMsg.style.display = 'block';
                    }
                };
                
                // X·ª≠ l√Ω s·ª± ki·ªán h·ªßy
                const cancelHandler = function() {
                    modal.style.display = 'none';
                    if (callback) callback(false);
                };
                
                // G√°n s·ª± ki·ªán
                document.getElementById('submitPassword').onclick = confirmHandler;
                document.getElementById('cancelAuth').onclick = cancelHandler;
                
                // X·ª≠ l√Ω nh·∫•n ph√≠m Enter
                passwordInput.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        confirmHandler();
                    }
                };
            }
            
            // Thi·∫øt l·∫≠p l·∫Øng nghe d·ªØ li·ªáu th·ªùi gian th·ª±c
            function setupRealtimeListener() {
                unsubscribe = db.collection('purchases').onSnapshot((snapshot) => {
                    purchaseData = {};
                    snapshot.forEach((doc) => {
                        purchaseData[doc.id] = doc.data();
                    });
                    
                    // C·∫≠p nh·∫≠t giao di·ªán sau khi ƒë·ªìng b·ªô
                    document.getElementById('viewDate').dispatchEvent(new Event('change'));
                    document.getElementById('monthSelector').dispatchEvent(new Event('change'));
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë·ªìng b·ªô
                    document.getElementById('syncStatus').className = 'sync-status sync-online';
                    document.getElementById('syncMessage').textContent = 'D·ªØ li·ªáu ƒë√£ ƒë·ªìng b·ªô';
                }, (error) => {
                    console.error('L·ªói khi l·∫Øng nghe d·ªØ li·ªáu:', error);
                    document.getElementById('syncStatus').className = 'sync-status sync-offline';
                    document.getElementById('syncMessage').textContent = 'M·∫•t k·∫øt n·ªëi, ƒëang th·ª≠ l·∫°i...';
                });
            }
            
            // B·ªî SUNG: T√≠nh to√°n t·ªïng ti·ªÅn cho c√°c m·ª•c nh·∫≠p li·ªáu Th·ªãt/H·∫£i s·∫£n
            function updateDailyInputTotals() {
                let totalMeat = 0;
                let totalSeafood = 0;
                
                // T√≠nh t·ªïng th·ªãt
                document.querySelectorAll('#meatItems .food-item').forEach(item => {
                    const totalInput = item.querySelector('input[placeholder*="Th√†nh ti·ªÅn"]');
                    if (totalInput && totalInput.value) {
                        // Chuy·ªÉn ƒë·ªïi chu·ªói ƒë·ªãnh d·∫°ng VND ng∆∞·ª£c l·∫°i th√†nh s·ªë ƒë·ªÉ t√≠nh to√°n
                        const value = totalInput.value.replace(/(\.|\s)*/g, ''); 
                        totalMeat += parseFloat(value) || 0;
                    }
                });
                document.getElementById('totalMeatAmount').textContent = formatCurrencyVND(totalMeat) + ' VND';

                // T√≠nh t·ªïng h·∫£i s·∫£n
                document.querySelectorAll('#seafoodItems .food-item').forEach(item => {
                    const totalInput = item.querySelector('input[placeholder*="Th√†nh ti·ªÅn"]');
                    if (totalInput && totalInput.value) {
                        // Chuy·ªÉn ƒë·ªïi chu·ªói ƒë·ªãnh d·∫°ng VND ng∆∞·ª£c l·∫°i th√†nh s·ªë ƒë·ªÉ t√≠nh to√°n
                        const value = totalInput.value.replace(/(\.|\s)*/g, '');
                        totalSeafood += parseFloat(value) || 0;
                    }
                });
                document.getElementById('totalSeafoodAmount').textContent = formatCurrencyVND(totalSeafood) + ' VND';
            }
            // K·∫æT TH√öC B·ªî SUNG

            // T√≠nh to√°n th√†nh ti·ªÅn khi s·ªë l∆∞·ª£ng ho·∫∑c ƒë∆°n gi√° thay ƒë·ªïi
            function setupCalculation() {
                document.querySelectorAll('.food-item').forEach(item => {
                    const quantityInput = item.querySelector('input[placeholder*="S·ªë l∆∞·ª£ng"]');
                    const priceInput = item.querySelector('input[placeholder*="ƒê∆°n gi√°"]');
                    const totalInput = item.querySelector('input[placeholder*="Th√†nh ti·ªÅn"]');
                    
                    if (quantityInput && priceInput && totalInput) {
                        const calculateTotal = () => {
                            const quantity = parseFloat(quantityInput.value) || 0;
                            const price = parseFloat(priceInput.value) || 0;
                            const total = quantity * price;
                            totalInput.value = formatCurrencyVND(total);
                            // B·ªî SUNG: C·∫≠p nh·∫≠t t·ªïng ti·ªÅn ngay khi t√≠nh to√°n xong
                            updateDailyInputTotals(); 
                            // K·∫æT TH√öC B·ªî SUNG
                        };
                        
                        quantityInput.addEventListener('input', calculateTotal);
                        priceInput.addEventListener('input', calculateTotal);
                    }
                });
            }

            // H√†m c·∫≠p nh·∫≠t c√°c √¥ th·ªëng k√™ (ƒê√É S·ª¨A ƒê·ªÇ T√çNH V√Ä HI·ªÇN TH·ªä C·∫¢ T·ªîNG TI·ªÄN THEO DANH M·ª§C)
            function updateStats(filteredData) {
                let totalDays = 0;
                let totalMeat = 0;
                let totalSeafood = 0;
                let totalMeatAmount = 0; // ƒê√É TH√äM
                let totalSeafoodAmount = 0; // ƒê√É TH√äM
                let totalAmount = 0;

                for (const data of Object.values(filteredData)) {
                    totalDays++;
                    
                    if (data.meat) {
                        for (const details of Object.values(data.meat)) {
                            // Ch·ªâ t√≠nh nh·ªØng m·∫∑t h√†ng c√≥ quantity > 0
                            if (details.quantity > 0) {
                                totalMeat += details.quantity;
                                const itemTotal = details.total || (details.quantity * details.price); // T√≠nh l·∫°i total n·∫øu b·ªã thi·∫øu
                                totalMeatAmount += itemTotal; // ƒê√É TH√äM
                                totalAmount += itemTotal;
                            }
                        }
                    }
                    
                    if (data.seafood) {
                        for (const details of Object.values(data.seafood)) {
                            // Ch·ªâ t√≠nh nh·ªØng m·∫∑t h√†ng c√≥ quantity > 0
                            if (details.quantity > 0) {
                                totalSeafood += details.quantity;
                                const itemTotal = details.total || (details.quantity * details.price); // T√≠nh l·∫°i total n·∫øu b·ªã thi·∫øu
                                totalSeafoodAmount += itemTotal; // ƒê√É TH√äM
                                totalAmount += itemTotal;
                            }
                        }
                    }
                }

                document.getElementById('totalDays').textContent = totalDays;
                document.getElementById('totalMeat').textContent = totalMeat.toFixed(2) + ' kg';
                document.getElementById('totalMeatAmountStat').textContent = formatCurrencyVND(totalMeatAmount) + ' VND'; // HI·ªÇN TH·ªä T·ªîNG TI·ªÄN TH·ªäT
                document.getElementById('totalSeafood').textContent = totalSeafood.toFixed(2) + ' kg';
                document.getElementById('totalSeafoodAmountStat').textContent = formatCurrencyVND(totalSeafoodAmount) + ' VND'; // HI·ªÇN TH·ªä T·ªîNG TI·ªÄN H·∫¢I S·∫¢N
                document.getElementById('totalAmount').textContent = formatCurrencyVND(totalAmount) + ' VND';
            }
            
            // # B·ªî SUNG: H√ÄM L∆ØU RI√äNG L·∫∫
            function collectAndSave(category) {
                const selectedDate = document.getElementById('selectedDate').value;
                if (!selectedDate) {
                    showNotification('Vui l√≤ng ch·ªçn ng√†y!', false);
                    return;
                }
                
                let hasDataToSave = false;
                const itemsToSave = {};

                // Ch·ªçn ƒë√∫ng ph·∫ßn t·ª≠ ch·ª©a c√°c m·ª•c c·∫ßn l∆∞u
                const containerId = category === 'meat' ? '#meatItems' : '#seafoodItems';
                
                document.querySelectorAll(`${containerId} .food-item`).forEach(item => {
                    const nameInput = item.querySelector('input[data-name]');
                    const quantityInput = item.querySelector('input[placeholder*="S·ªë l∆∞·ª£ng"]');
                    const priceInput = item.querySelector('input[placeholder*="ƒê∆°n gi√°"]');
                    
                    // L·∫•y t√™n m·∫∑t h√†ng t·ª´ label n·∫øu kh√¥ng c√≥ data-name (cho c√°c m·ª•c c·ªë ƒë·ªãnh)
                    let name = '';
                    if (nameInput && nameInput.dataset.name) {
                        name = nameInput.dataset.name;
                    } else {
                        // T√¨m label t∆∞∆°ng ·ª©ng trong food-item
                        const label = item.querySelector('label.form-label');
                        if (label) {
                            name = label.textContent.trim();
                        }
                    }

                    if (name && quantityInput && priceInput) {
                        const quantity = parseFloat(quantityInput.value);
                        // Ch·ªâ l∆∞u nh·ªØng m·ª•c c√≥ s·ªë l∆∞·ª£ng > 0
                        if (quantity > 0) {
                            const price = parseFloat(priceInput.value) || 0;
                            itemsToSave[name] = {
                                quantity: quantity,
                                price: price,
                                total: (quantity * price)
                            };
                            hasDataToSave = true;
                        }
                    }
                });

                if (!hasDataToSave) {
                    showNotification(`Kh√¥ng c√≥ d·ªØ li·ªáu s·ªë l∆∞·ª£ng > 0 ƒë·ªÉ l∆∞u trong m·ª•c ${category === 'meat' ? 'Th·ªãt' : 'H·∫£i s·∫£n'}!`, false);
                    return;
                }
                
                // L∆∞u d·ªØ li·ªáu l√™n Firebase. S·ª≠ d·ª•ng merge: true ƒë·ªÉ ch·ªâ c·∫≠p nh·∫≠t m·ª•c 'meat' ho·∫∑c 'seafood'
                db.collection('purchases').doc(selectedDate).set({
                    [category]: itemsToSave, // S·ª≠ d·ª•ng bi·∫øn ƒë·ªông [category]
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true })
                .then(() => {
                    showNotification(`ƒê√£ l∆∞u d·ªØ li·ªáu ${category === 'meat' ? 'Th·ªãt' : 'H·∫£i s·∫£n'} cho ng√†y ${selectedDate}`);
                    
                    // L√†m m·ªõi form (ch·ªâ x√≥a input s·ªë l∆∞·ª£ng v√† ƒë∆°n gi√° c·ªßa m·ª•c ƒë√£ l∆∞u)
                    document.querySelectorAll(`${containerId} .food-item input[type="number"]`).forEach(input => {
                        input.value = '';
                    });
                    document.querySelectorAll(`${containerId} .food-item input[placeholder*="Th√†nh ti·ªÅn"]`).forEach(input => {
                        input.value = '';
                    });
                    
                    // C·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn sau khi x√≥a input
                    updateDailyInputTotals();
                })
                .catch((error) => {
                    showNotification('L·ªói khi l∆∞u d·ªØ li·ªáu: ' + error.message, false);
                });
            }
            // # K·∫æT TH√öC B·ªî SUNG: H√ÄM L∆ØU RI√äNG L·∫∫

            // G√°n s·ª± ki·ªán cho c√°c n√∫t l∆∞u m·ªõi
            document.getElementById('saveMeatData').addEventListener('click', function() {
                collectAndSave('meat');
            });

            document.getElementById('saveSeafoodData').addEventListener('click', function() {
                collectAndSave('seafood');
            });

            // G·ª° b·ªè s·ª± ki·ªán cho n√∫t saveData c≈© (n·∫øu n√≥ kh√¥ng b·ªã ·∫©n)

            // Xem d·ªØ li·ªáu theo ng√†y (ƒê√É S·ª¨A ƒê·ªÇ HI·ªÇN TH·ªä T·ªîNG TR·ª∞C TI·∫æP)
            document.getElementById('viewDate').addEventListener('change', function() {
                const viewDate = this.value;
                const tableBody = document.querySelector('#dataTable tbody');
                tableBody.innerHTML = '';
                
                // ·∫®n c·ªôt ch·ªânh s·ª≠a n·∫øu kh√¥ng ·ªü ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
                document.getElementById('editColumnHeader').style.display = isEditMode ? 'table-cell' : 'none';
                
                // Kh·ªüi t·∫°o bi·∫øn cho t√≥m t·∫Øt tr·ª±c ti·∫øp
                let dailyMeatQty = 0;
                let dailySeafoodQty = 0;
                let dailyMeatAmount = 0;
                let dailySeafoodAmount = 0;
                
                if (purchaseData[viewDate]) {
                    const data = purchaseData[viewDate];
                    let totalAmount = 0;
                    
                    const renderItems = (items) => {
                        for (const [item, details] of Object.entries(items)) {
                            // S·ª≠a l·ªói n·∫øu details.total ch∆∞a ƒë∆∞·ª£c t√≠nh
                            const itemTotal = details.total || (details.quantity * details.price); 

                            if (details.quantity > 0) {
                                // C·∫≠p nh·∫≠t t·ªïng h√†ng ng√†y
                                if (items === data.meat) {
                                    dailyMeatQty += details.quantity;
                                    dailyMeatAmount += itemTotal;
                                } else if (items === data.seafood) {
                                    dailySeafoodQty += details.quantity;
                                    dailySeafoodAmount += itemTotal;
                                }
                                
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${item}</td>
                                    <td>${details.quantity} kg</td>
                                    <td>${formatCurrencyVND(details.price)}</td>
                                    <td>${formatCurrencyVND(itemTotal)}</td>
                                    ${isEditMode ? `<td>
                                        <button class="btn btn-sm btn-outline-primary edit-item" data-category="${items === data.meat ? 'meat' : 'seafood'}" data-item="${item}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>` : ''}
                                `;
                                tableBody.appendChild(row);
                                totalAmount += itemTotal;
                            }
                        }
                    }

                    // Hi·ªÉn th·ªã th·ªãt
                    if (data.meat) renderItems(data.meat);
                    
                    // Hi·ªÉn th·ªã h·∫£i s·∫£n
                    if (data.seafood) renderItems(data.seafood);
                    
                    // Hi·ªÉn th·ªã t·ªïng chung
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'total-row';
                    totalRow.innerHTML = `
                        <td colspan="${isEditMode ? '4' : '3'}"><strong>T·ªïng c·ªông</strong></td>
                        <td><strong>${formatCurrencyVND(totalAmount)} VND</strong></td>
                    `;
                    tableBody.appendChild(totalRow);
                    
                    // Hi·ªÉn th·ªã th√¥ng tin c·∫≠p nh·∫≠t
                    const infoRow = document.createElement('tr');
                    infoRow.innerHTML = `
                        <td colspan="${isEditMode ? '5' : '4'}" class="text-muted small">
                            C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: 
                            ${data.updatedAt ? new Date(data.updatedAt.toDate()).toLocaleString('vi-VN') : 'N/A'}
                        </td>
                    `;
                    tableBody.appendChild(infoRow);
                    
                    // C·∫≠p nh·∫≠t T√ìM T·∫ÆT TR·ª∞C TI·∫æP
                    const dailySummaryDiv = document.getElementById('dailySummary');
                    dailySummaryDiv.style.display = 'block';
                    dailySummaryDiv.innerHTML = `
                        <p class="mb-1"><strong>ü•© Th·ªãt: </strong> T·ªïng l∆∞·ª£ng: ${dailyMeatQty.toFixed(2)} kg | T·ªïng ti·ªÅn: <span class="text-primary fw-bold">${formatCurrencyVND(dailyMeatAmount)} VND</span></p>
                        <p class="mb-0"><strong>ü¶ê H·∫£i s·∫£n: </strong> T·ªïng l∆∞·ª£ng: ${dailySeafoodQty.toFixed(2)} kg | T·ªïng ti·ªÅn: <span class="text-primary fw-bold">${formatCurrencyVND(dailySeafoodAmount)} VND</span></p>
                    `;
                    
                    // Th√™m s·ª± ki·ªán cho c√°c n√∫t ch·ªânh s·ª≠a
                    if (isEditMode) {
                        document.querySelectorAll('.edit-item').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const category = this.dataset.category;
                                const itemName = this.dataset.item;
                                editItem(viewDate, category, itemName);
                            });
                        });
                    }
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="${isEditMode ? '5' : '4'}" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu cho ng√†y n√†y</td>
                    `;
                    tableBody.appendChild(row);
                    document.getElementById('dailySummary').style.display = 'none';
                }
            });
            
            // Ch·ªânh s·ª≠a m·∫∑t h√†ng
            function editItem(date, category, itemName) {
                const data = purchaseData[date];
                if (!data || !data[category] || !data[category][itemName]) return;
                
                const itemData = data[category][itemName];
                
                // Hi·ªÉn th·ªã modal ch·ªânh s·ª≠a
                const newQty = prompt(`Ch·ªânh s·ª≠a S·ªê L∆Ø·ª¢NG (kg) cho "${itemName}":`, itemData.quantity);
                
                if (newQty !== null) {
                    const quantity = parseFloat(newQty);
                    if (isNaN(quantity) || quantity < 0) {
                        showNotification('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá!', false);
                        return;
                    }

                    const newPrice = prompt(`Ch·ªânh s·ª≠a ƒê∆†N GI√Å (VND) cho "${itemName}":`, itemData.price);
                    
                    if (newPrice !== null) {
                        const price = parseFloat(newPrice) || 0;
                        if (isNaN(price) || price < 0) {
                            showNotification('ƒê∆°n gi√° kh√¥ng h·ª£p l·ªá!', false);
                            return;
                        }

                        // C·∫≠p nh·∫≠t d·ªØ li·ªáu
                        db.collection('purchases').doc(date).set({
                            [category]: {
                                ...data[category],
                                [itemName]: {
                                    quantity: quantity,
                                    price: price,
                                    total: quantity * price // T√≠nh l·∫°i t·ªïng
                                }
                            },
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true })
                        .then(() => {
                            showNotification(`ƒê√£ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng v√† ƒë∆°n gi√° ${itemName}`);
                        })
                        .catch((error) => {
                            showNotification('L·ªói khi c·∫≠p nh·∫≠t: ' + error.message, false);
                        });
                    }
                }
            }
            
            // K√≠ch ho·∫°t xem d·ªØ li·ªáu ng√†y hi·ªán t·∫°i
            document.getElementById('viewDate').dispatchEvent(new Event('change'));
            
            // X√≥a d·ªØ li·ªáu theo ng√†y
            document.getElementById('deleteDate').addEventListener('click', function() {
                const viewDate = document.getElementById('viewDate').value;
                
                if (purchaseData[viewDate]) {
                    // Y√™u c·∫ßu x√°c th·ª±c tr∆∞·ªõc khi x√≥a
                    if (!isAuthenticated) {
                        showAuthModal(function(success) {
                            if (success) {
                                // Sau khi x√°c th·ª±c th√†nh c√¥ng, th·ª±c hi·ªán x√≥a
                                if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ªØ li·ªáu ng√†y ' + viewDate + '?')) {
                                    db.collection('purchases').doc(viewDate).delete()
                                        .then(() => {
                                            showNotification('ƒê√£ x√≥a d·ªØ li·ªáu ng√†y ' + viewDate);
                                        })
                                        .catch((error) => {
                                            showNotification('L·ªói khi x√≥a d·ªØ li·ªáu: ' + error.message, false);
                                        });
                                }
                            }
                        });
                    } else {
                        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ªØ li·ªáu ng√†y ' + viewDate + '?')) {
                            db.collection('purchases').doc(viewDate).delete()
                                .then(() => {
                                    showNotification('ƒê√£ x√≥a d·ªØ li·ªáu ng√†y ' + viewDate);
                                })
                                .catch((error) => {
                                    showNotification('L·ªói khi x√≥a d·ªØ li·ªáu: ' + error.message, false);
                                });
                        }
                    }
                } else {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ x√≥a cho ng√†y n√†y', false);
                }
            });
            
            // ƒê√É X√ìA CH·ª®C NƒÇNG C·ª¶A calculateTotal BUTTON THEO Y√äU C·∫¶U

            // Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
            document.getElementById('toggleEditMode').addEventListener('click', function() {
                if (!isAuthenticated) {
                    showAuthModal(function(success) {
                        if (success) {
                            isEditMode = !isEditMode;
                            document.getElementById('toggleEditMode').innerHTML = 
                                isEditMode ? 
                                '<i class="fas fa-times me-2"></i>Tho√°t ch·ªânh s·ª≠a' : 
                                '<i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a';
                            
                            // C·∫≠p nh·∫≠t l·∫°i b·∫£ng
                            document.getElementById('viewDate').dispatchEvent(new Event('change'));
                        }
                    });
                } else {
                    isEditMode = !isEditMode;
                    document.getElementById('toggleEditMode').innerHTML = 
                        isEditMode ? 
                        '<i class="fas fa-times me-2"></i>Tho√°t ch·ªânh s·ª≠a' : 
                        '<i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a';
                    
                    // C·∫≠p nh·∫≠t l·∫°i b·∫£ng
                    document.getElementById('viewDate').dispatchEvent(new Event('change'));
                }
            });

            // Thi·∫øt l·∫≠p th·ªëng k√™ th√°ng
            document.getElementById('monthSelector').addEventListener('change', function() {
                const month = this.value;
                if (!month) return;
                
                const startDate = month + '-01';
                // L·∫•y ng√†y cu·ªëi c√πng c·ªßa th√°ng
                const endDate = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]), 0).toISOString().split('T')[0];
                
                const filteredData = {};
                for (const [date, data] of Object.entries(purchaseData)) {
                    if (date >= startDate && date <= endDate) {
                        filteredData[date] = data;
                    }
                }
                
                updateStats(filteredData);
            });

            // T√≠nh to√°n th·ªëng k√™ theo kho·∫£ng ng√†y m·ªõi
            document.getElementById('calculateDateRange').addEventListener('click', function() {
                const startDate = document.getElementById('startDateSelector').value;
                const endDate = document.getElementById('endDateSelector').value;
                
                if (!startDate || !endDate) {
                    showNotification('Vui l√≤ng ch·ªçn c·∫£ Ng√†y b·∫Øt ƒë·∫ßu v√† Ng√†y k·∫øt th√∫c!', false);
                    return;
                }
                
                if (startDate > endDate) {
                    showNotification('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ l·ªõn h∆°n Ng√†y k·∫øt th√∫c!', false);
                    return;
                }
                
                const filteredData = {};
                for (const [date, data] of Object.entries(purchaseData)) {
                    // L·ªçc d·ªØ li·ªáu trong kho·∫£ng [startDate, endDate]
                    if (date >= startDate && date <= endDate) {
                        filteredData[date] = data;
                    }
                }
                
                if (Object.keys(filteredData).length === 0) {
                    showNotification(`Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng t·ª´ ${startDate} ƒë·∫øn ${endDate}`, false);
                    updateStats({}); 
                    return;
                }
                
                showNotification(`ƒê√£ t√≠nh t·ªïng t·ª´ ng√†y ${startDate} ƒë·∫øn ${endDate}`);
                updateStats(filteredData);
            });
            
            // # B·ªî SUNG: XU·∫§T FILE EXCEL ƒêA SHEET V√Ä ƒê·ªäNH D·∫†NG S·ªê TI·ªÄN (ƒê√É S·ª¨A TH√äM T·ªîNG TI·ªÄN THEO DANH M·ª§C)
            document.getElementById('exportExcel').addEventListener('click', function() {
                const month = document.getElementById('monthSelector').value;
                const startDateRange = document.getElementById('startDateSelector').value;
                const endDateRange = document.getElementById('endDateSelector').value;

                let exportStartDate, exportEndDate;
                let exportName;
                let filteredData = {};

                // ∆Øu ti√™n th·ªëng k√™ theo kho·∫£ng ng√†y n·∫øu c√≥
                if (startDateRange && endDateRange) {
                    if (startDateRange > endDateRange) {
                        showNotification('Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ l·ªõn h∆°n Ng√†y k·∫øt th√∫c!', false);
                        return;
                    }
                    exportStartDate = startDateRange;
                    exportEndDate = endDateRange;
                    exportName = `Khoang_ngay_${exportStartDate}_den_${exportEndDate}`;
                } 
                // N·∫øu kh√¥ng, xu·∫•t theo th√°ng
                else if (month) {
                    exportStartDate = month + '-01';
                    // L·∫•y ng√†y cu·ªëi c√πng c·ªßa th√°ng
                    exportEndDate = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]), 0).toISOString().split('T')[0];
                    exportName = `Thang_${month}`;
                } else {
                    showNotification('Vui l√≤ng ch·ªçn Th√°ng ho·∫∑c Kho·∫£ng ng√†y ƒë·ªÉ xu·∫•t Excel!', false);
                    return;
                }
                
                // L·ªçc d·ªØ li·ªáu
                for (const [date, data] of Object.entries(purchaseData)) {
                    if (date >= exportStartDate && date <= exportEndDate) {
                        filteredData[date] = data;
                    }
                }

                if (Object.keys(filteredData).length === 0) {
                    showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t file Excel', false);
                    return;
                }
                
                // Chu·∫©n b·ªã d·ªØ li·ªáu cho Excel (3 sheets)
                // ƒê√É S·ª¨A HEADER ƒê·ªÇ TH√äM C·ªòT T·ªîNG TI·ªÄN TH·ªäT/H·∫¢I S·∫¢N
                let wsDataTotal = [['Ng√†y', 'T·ªïng Chi Ph√≠ (VND)', 'T·ªïng Ti·ªÅn Th·ªãt (VND)', 'T·ªïng Ti·ªÅn H·∫£i S·∫£n (VND)']]; 
                let wsDataMeat = [['Ng√†y', 'M·∫∑t h√†ng', 'S·ªë l∆∞·ª£ng (kg)', 'ƒê∆°n gi√° (VND)', 'Th√†nh ti·ªÅn (VND)']];
                let wsDataSeafood = [['Ng√†y', 'M·∫∑t h√†ng', 'S·ªë l∆∞·ª£ng (kg)', 'ƒê∆°n gi√° (VND)', 'Th√†nh ti·ªÅn (VND)']];
                
                for (const [date, data] of Object.entries(filteredData)) {
                    let dailyTotal = 0;
                    let dailyMeatTotal = 0; // ƒê√É TH√äM
                    let dailySeafoodTotal = 0; // ƒê√É TH√äM
                    
                    const processItems = (items, sheetData) => {
                        for (const [item, details] of Object.entries(items)) {
                            if (details.quantity > 0) {
                                
                                const finalTotal = details.total || (details.quantity * details.price); 
                                dailyTotal += finalTotal;
                                
                                // Ghi nh·∫≠n t·ªïng ti·ªÅn theo danh m·ª•c
                                if (sheetData === wsDataMeat) dailyMeatTotal += finalTotal;
                                else if (sheetData === wsDataSeafood) dailySeafoodTotal += finalTotal;
                                
                                sheetData.push([
                                    date,
                                    item,
                                    details.quantity,
                                    details.price,
                                    Math.round(finalTotal) // Ti·ªÅn ƒë∆∞·ª£c l√†m tr√≤n
                                ]);
                            }
                        }
                    }

                    if (data.meat) processItems(data.meat, wsDataMeat);
                    if (data.seafood) processItems(data.seafood, wsDataSeafood);
                    
                    // Th√™m v√†o sheet T·ªïng Chi Ph√≠ (Bao g·ªìm T·ªïng ti·ªÅn Th·ªãt v√† H·∫£i s·∫£n)
                    wsDataTotal.push([
                        date,
                        Math.round(dailyTotal),
                        Math.round(dailyMeatTotal),
                        Math.round(dailySeafoodTotal)
                    ]);
                }
                
                // T·∫°o workbook
                const wb = XLSX.utils.book_new();
                
                // SHEET 1: T·ªîNG CHI PH√ç
                const wsTotal = XLSX.utils.aoa_to_sheet(wsDataTotal);
                XLSX.utils.book_append_sheet(wb, wsTotal, '01. Tong_Chi_Phi');
                
                // SHEET 2: TH·ªäT
                const wsMeat = XLSX.utils.aoa_to_sheet(wsDataMeat);
                XLSX.utils.book_append_sheet(wb, wsMeat, '02. Chi_Tiet_Thit');
                
                // SHEET 3: H·∫¢I S·∫¢N
                const wsSeafood = XLSX.utils.aoa_to_sheet(wsDataSeafood);
                XLSX.utils.book_append_sheet(wb, wsSeafood, '03. Chi_Tiet_Hai_San');

                // T√πy ch·ªânh ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn VND (200.000)
                const numberFormat = '#,##0'; 
                
                // √Åp d·ª•ng ƒë·ªãnh d·∫°ng cho c√°c c·ªôt ti·ªÅn t·ªá
                const applyNumberFormat = (ws, cols) => {
                    if (!ws['!ref']) return;
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for(let R = range.s.r + 1; R <= range.e.r; ++R) {
                        cols.forEach(C => {
                            const cell = ws[XLSX.utils.encode_cell({c: C, r: R})];
                            if(cell && cell.t === 'n') cell.z = numberFormat;
                        });
                    }
                };

                // Sheet 01. Tong_Chi_Phi: c·ªôt B (index 1), C (index 2), D (index 3)
                applyNumberFormat(wsTotal, [1, 2, 3]); 
                
                // Sheet 02. Chi_Tiet_Thit: c·ªôt D (index 3) v√† E (index 4)
                applyNumberFormat(wsMeat, [3, 4]);
                
                // Sheet 03. Chi_Tiet_Hai_San: c·ªôt D (index 3) v√† E (index 4)
                applyNumberFormat(wsSeafood, [3, 4]);
                
                // Xu·∫•t file
                XLSX.writeFile(wb, `Du_lieu_mua_hang_${exportName}.xlsx`);
                showNotification('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng');
            });
            // # K·∫æT TH√öC B·ªî SUNG: XU·∫§T FILE EXCEL

            // Th√™m m·∫∑t h√†ng th·ªãt m·ªõi
            document.getElementById('addMeatBtn').addEventListener('click', function() {
                const nameInput = document.getElementById('otherMeatName');
                const qtyInput = document.getElementById('otherMeatQty');
                const priceInput = document.getElementById('otherMeatPrice');
                
                const name = nameInput.value.trim();
                const qty = parseFloat(qtyInput.value);
                const price = parseFloat(priceInput.value) || 0;
                
                if (!name || isNaN(qty) || qty <= 0) {
                    showNotification('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n m·∫∑t h√†ng v√† S·ªë l∆∞·ª£ng > 0', false);
                    return;
                }
                
                const newItem = document.createElement('div');
                newItem.className = 'food-item';
                newItem.innerHTML = `
                    <label class="form-label">${name}</label>
                    <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="${name}" min="0" step="0.1" value="${qty}">
                    <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="${name}" min="0" value="${price}">
                    <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="${name}" readonly value="${formatCurrencyVND(qty * price)}">
                `;
                
                // Th√™m v√†o tr∆∞·ªõc ph·∫ßn t·ª≠ cu·ªëi c√πng (Kh√°c)
                document.getElementById('meatItems').insertBefore(newItem, document.getElementById('meatItems').lastElementChild);
                
                // Thi·∫øt l·∫≠p t√≠nh to√°n cho m·∫∑t h√†ng m·ªõi
                const quantityInput = newItem.querySelector('input[placeholder*="S·ªë l∆∞·ª£ng"]');
                const priceInputNew = newItem.querySelector('input[placeholder*="ƒê∆°n gi√°"]');
                const totalInput = newItem.querySelector('input[placeholder*="Th√†nh ti·ªÅn"]');
                
                const calculateTotal = () => {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInputNew.value) || 0;
                    totalInput.value = formatCurrencyVND(quantity * price);
                    // B·ªî SUNG
                    updateDailyInputTotals(); 
                    // K·∫æT TH√öC B·ªî SUNG
                };
                
                quantityInput.addEventListener('input', calculateTotal);
                priceInputNew.addEventListener('input', calculateTotal);
                
                // X√≥a d·ªØ li·ªáu ƒë√£ nh·∫≠p
                nameInput.value = '';
                qtyInput.value = '';
                priceInput.value = '';
                
                // B·ªî SUNG: C·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn cho m·ª•c Th·ªãt
                updateDailyInputTotals(); 
                // K·∫æT TH√öC B·ªî SUNG

                showNotification(`ƒê√£ th√™m m·∫∑t h√†ng "${name}" v√†o danh s√°ch th·ªãt`);
            });
            
            // Th√™m m·∫∑t h√†ng h·∫£i s·∫£n m·ªõi
            document.getElementById('addSeafoodBtn').addEventListener('click', function() {
                const nameInput = document.getElementById('otherSeafoodName');
                const qtyInput = document.getElementById('otherSeafoodQty');
                const priceInput = document.getElementById('otherSeafoodPrice');
                
                const name = nameInput.value.trim();
                const qty = parseFloat(qtyInput.value);
                const price = parseFloat(priceInput.value) || 0;
                
                if (!name || isNaN(qty) || qty <= 0) {
                    showNotification('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n m·∫∑t h√†ng v√† S·ªë l∆∞·ª£ng > 0', false);
                    return;
                }
                
                const newItem = document.createElement('div');
                newItem.className = 'food-item';
                newItem.innerHTML = `
                    <label class="form-label">${name}</label>
                    <input type="number" class="form-control" placeholder="S·ªë l∆∞·ª£ng (kg)" data-name="${name}" min="0" step="0.1" value="${qty}">
                    <input type="number" class="form-control price-input" placeholder="ƒê∆°n gi√°" data-name="${name}" min="0" value="${price}">
                    <input type="text" class="form-control" placeholder="Th√†nh ti·ªÅn" data-name="${name}" readonly value="${formatCurrencyVND(qty * price)}">
                `;
                
                // Th√™m v√†o tr∆∞·ªõc ph·∫ßn t·ª≠ cu·ªëi c√πng (Kh√°c)
                document.getElementById('seafoodItems').insertBefore(newItem, document.getElementById('seafoodItems').lastElementChild);
                
                // Thi·∫øt l·∫≠p t√≠nh to√°n cho m·∫∑t h√†ng m·ªõi
                const quantityInput = newItem.querySelector('input[placeholder*="S·ªë l∆∞·ª£ng"]');
                const priceInputNew = newItem.querySelector('input[placeholder*="ƒê∆°n gi√°"]');
                const totalInput = newItem.querySelector('input[placeholder*="Th√†nh ti·ªÅn"]');
                
                const calculateTotal = () => {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInputNew.value) || 0;
                    totalInput.value = formatCurrencyVND(quantity * price);
                    // B·ªî SUNG
                    updateDailyInputTotals();
                    // K·∫æT TH√öC B·ªî SUNG
                };
                
                quantityInput.addEventListener('input', calculateTotal);
                priceInputNew.addEventListener('input', calculateTotal);
                
                // X√≥a d·ªØ li·ªáu ƒë√£ nh·∫≠p
                nameInput.value = '';
                qtyInput.value = '';
                priceInput.value = '';
                
                // B·ªî SUNG: C·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn cho m·ª•c H·∫£i s·∫£n
                updateDailyInputTotals();
                // K·∫æT TH√öC B·ªî SUNG
                
                showNotification(`ƒê√£ th√™m m·∫∑t h√†ng "${name}" v√†o danh s√°ch h·∫£i s·∫£n`);
            });
            
            // Thi·∫øt l·∫≠p th√°ng hi·ªán t·∫°i v√† k√≠ch ho·∫°t th·ªëng k√™ ban ƒë·∫ßu
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('monthSelector').value = currentMonth;
            
            // Kh·ªüi t·∫°o
            setupCalculation();
            setupRealtimeListener();
            
            // B·ªî SUNG: Ch·∫°y h√†m t√≠nh t·ªïng input ban ƒë·∫ßu ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
            updateDailyInputTotals();
        });
    </script>
</body>

</html>