<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhtan361</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --light-color: #f8f9fa;
            --dark-color: #343a3d;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            padding-top: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s;
            margin-bottom: 20px;
            border: none;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-top-left-radius: 12px !important;
            border-top-right-radius: 12px !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        
        .form-control {
            border-radius: 8px;
            padding: 12px 15px;
        }
        
        .table th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .highlight {
            background-color: #fff8e1;
        }
        
        .section-title {
            border-left: 5px solid var(--primary-color);
            padding-left: 15px;
            margin: 25px 0 20px;
            color: var(--dark-color);
            font-size: 1.15rem;
            font-weight: 600;
        }

        .section-title:first-child {
            margin-top: 5px;
        }
        
        .stats-box {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stats-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .stats-label {
            font-size: 1rem;
            color: #6c757d;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .food-item {
            margin-bottom: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .food-item label {
            grid-column: 1 / 4;
            font-weight: 500;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            background: var(--secondary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }
        
        .price-input {
            position: relative;
        }
        
        .price-input::after {
            content: "VND";
            position: absolute;
            right: 10px;
            top: 12px;
            color: #6c757d;
            pointer-events: none; /* Quan trọng để không ngăn cản input */
        }
        
        .sync-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .sync-online {
            background-color: #2ecc71;
        }
        
        .sync-offline {
            background-color: #e74c3c;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #e8f5e9 !important;
        }
        
        .editable-row {
            background-color: #e3f2fd !important;
        }
        
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .auth-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
        }
        
        @media (max-width: 768px) {
            .food-item {
                grid-template-columns: 1fr;
            }
            
            .food-item label {
                grid-column: 1;
            }
            
            .auth-content {
                width: 90%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1><i class="fas fa-shopping-cart me-2"></i>Nhập Liệu Hằng Ngày</h1>
            <p class="lead">minhtan361 - THAITHAE</p>
            <div class="d-flex justify-content-center align-items-center mt-3">
                <span class="sync-status sync-online" id="syncStatus"></span>
                <small id="syncMessage">Đang đồng bộ dữ liệu...</small>
            </div>
        </div>
        
        <div class="notification" id="notification"></div>
        
        <div class="auth-modal" id="authModal">
            <div class="auth-content">
                <h3 class="text-center mb-4">Xác thực quyền quản trị</h3>
                <div class="mb-3">
                    <label for="passwordInput" class="form-label">Mật khẩu:</label>
                    <input type="password" class="form-control" id="passwordInput" placeholder="Nhập mật khẩu">
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="submitPassword">Xác nhận</button>
                    <button class="btn btn-secondary" id="cancelAuth">Hủy</button>
                </div>
                <p class="text-center mt-3 text-danger" id="authError" style="display: none;">Mật khẩu không đúng!</p>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-day me-2"></i>Thông Tin
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="selectedDate" class="form-label">Chọn ngày:</label>
                            <input type="date" class="form-control" id="selectedDate" required>
                        </div>
                        
                        <h4 class="section-title">Thịt</h4>
                        <div id="meatItems">
                            <div class="food-item">
                                <label class="form-label">Sườn cay</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Sườn cay" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Sườn cay" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Sườn cay" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Ba rọi</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Ba rọi" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Ba rọi" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Ba rọi" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Bằm</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Bằm" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Bằm" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Bằm" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Khác</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="otherMeatName" placeholder="Tên mặt hàng">
                                </div>
                                <input type="number" class="form-control" id="otherMeatQty" placeholder="Số lượng" min="0" step="0.1">
                                <input type="number" class="form-control price-input" id="otherMeatPrice" placeholder="Đơn giá" min="0">
                                <button class="btn btn-outline-secondary" type="button" id="addMeatBtn">Thêm</button>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary btn-lg" id="saveMeatData">
                                <i class="fas fa-drumstick-bite me-2"></i>Lưu thông tin Thịt
                            </button>
                        </div>

                        <h4 class="section-title">Hải sản</h4>
                        <div id="seafoodItems">
                            <div class="food-item">
                                <label class="form-label">Tôm</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Tôm" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Tôm" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Tôm" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Mực</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Mực" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Mực" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Mực" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Sò huyết</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Sò huyết" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Sò huyết" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Sò huyết" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Bạch tuộc</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Bạch tuộc" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Bạch tuộc" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Bạch tuộc" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Bún</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Bún" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Bún" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Bún" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Đậu hủ</label>
                                <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="Đậu hủ" min="0" step="0.1">
                                <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="Đậu hủ" min="0">
                                <input type="text" class="form-control" placeholder="Thành tiền" data-name="Đậu hủ" readonly>
                            </div>
                            <div class="food-item">
                                <label class="form-label">Khác</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="otherSeafoodName" placeholder="Tên mặt hàng">
                                </div>
                                <input type="number" class="form-control" id="otherSeafoodQty" placeholder="Số lượng" min="0" step="0.1">
                                <input type="number" class="form-control price-input" id="otherSeafoodPrice" placeholder="Đơn giá" min="0">
                                <button class="btn btn-outline-secondary" type="button" id="addSeafoodBtn">Thêm</button>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary btn-lg" id="saveSeafoodData">
                                <i class="fas fa-fish me-2"></i>Lưu thông tin Hải sản
                            </button>
                        </div>

                        <div class="d-grid gap-2 mt-4" style="display: none;">
                            <button class="btn btn-primary btn-lg" id="saveData">
                                <i class="fas fa-save me-2"></i>Lưu toàn bộ thông tin
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i>Dữ liệu đã nhập
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="viewDate" class="form-label">Chọn ngày để xem:</label>
                            <input type="date" class="form-control" id="viewDate">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="dataTable">
                                <thead>
                                    <tr>
                                        <th>Mặt hàng</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá (VND)</th>
                                        <th>Thành tiền (VND)</th>
                                        <th id="editColumnHeader" style="display: none;">Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-danger" id="deleteDate">
                                <i class="fas fa-trash me-2"></i>Xóa dữ liệu ngày này
                            </button>
                            <button class="btn btn-success" id="calculateTotal">
                                <i class="fas fa-calculator me-2"></i>Tính tổng
                            </button>
                            <button class="btn btn-warning" id="toggleEditMode">
                                <i class="fas fa-edit me-2"></i>Chỉnh sửa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-pie me-2"></i>Thống kê
                    </div>
                    <div class="card-body">
                        <h5 class="section-title">Thống kê theo tháng</h5>
                        <div class="mb-3">
                            <label for="monthSelector" class="form-label">Chọn tháng:</label>
                            <input type="month" class="form-control" id="monthSelector">
                        </div>

                        <hr>
                        
                        <h5 class="section-title">Thống kê theo khoảng ngày</h5>
                        <div class="mb-3">
                            <label for="startDateSelector" class="form-label">Ngày bắt đầu:</label>
                            <input type="date" class="form-control" id="startDateSelector">
                        </div>
                        <div class="mb-3">
                            <label for="endDateSelector" class="form-label">Ngày kết thúc:</label>
                            <input type="date" class="form-control" id="endDateSelector">
                        </div>
                        <div class="d-grid gap-2 mb-4">
                            <button class="btn btn-secondary" id="calculateDateRange">
                                <i class="fas fa-calendar-alt me-2"></i>Tính tổng theo khoảng ngày
                            </button>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalDays">0</div>
                            <div class="stats-label">Số ngày có dữ liệu</div>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalMeat">0 kg</div>
                            <div class="stats-label">Tổng lượng thịt</div>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalSeafood">0 kg</div>
                            <div class="stats-label">Tổng lượng hải sản</div>
                        </div>
                        
                        <div class="stats-box mb-3">
                            <div class="stats-number" id="totalAmount">0 VND</div>
                            <div class="stats-label">Tổng tiền</div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="exportExcel">
                                <i class="fas fa-file-excel me-2"></i>Xuất file Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>minhtan361 - THAITHAE &copy; 2025 - Dữ liệu được đồng bộ thời gian thực pls đừng sao chép của tôi </p>
        </footer>
    </div>

    <script>
        // Cấu hình Firebase - Sử dụng cấu hình của bạn
        const firebaseConfig = {
            apiKey: "AIzaSyDOPvcf8_zKxkMAUeI56QlNPXxDtz-jaJE",
            authDomain: "nguyenlieu-9de17.firebaseapp.com",
            projectId: "nguyenlieu-9de17",
            storageBucket: "nguyenlieu-9de17.firebasestorage.app",
            messagingSenderId: "1083805342364",
            appId: "1:1083805342364:web:fd99aac7d0174ea008eb59",
            measurementId: "G-0RPVKN6M5T"
        };
        
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Biến toàn cục
        let purchaseData = {};
        let unsubscribe = null;
        let isAuthenticated = false;
        let isEditMode = false;
        let currentEditingDate = null;
        
        // Hàm định dạng số tiền theo kiểu Việt Nam (cho hiển thị HTML)
        function formatCurrencyVND(amount) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(amount)); // Làm tròn để tránh lỗi số lẻ
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Thiết lập ngày mặc định là ngày hôm nay
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selectedDate').value = today;
            document.getElementById('viewDate').value = today;
            
            // Hàm hiển thị thông báo
            function showNotification(message, isSuccess = true) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.backgroundColor = isSuccess ? '#2ecc71' : '#e74c3c';
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
            
            // Hàm hiển thị modal xác thực
            function showAuthModal(callback) {
                const modal = document.getElementById('authModal');
                const errorMsg = document.getElementById('authError');
                const passwordInput = document.getElementById('passwordInput');
                
                // Reset modal
                passwordInput.value = '';
                errorMsg.style.display = 'none';
                
                // Hiển thị modal
                modal.style.display = 'flex';
                
                // Xử lý sự kiện xác nhận
                const confirmHandler = function() {
                    if (passwordInput.value === 'thaithae2025@') {
                        isAuthenticated = true;
                        modal.style.display = 'none';
                        if (callback) callback(true);
                    } else {
                        errorMsg.style.display = 'block';
                    }
                };
                
                // Xử lý sự kiện hủy
                const cancelHandler = function() {
                    modal.style.display = 'none';
                    if (callback) callback(false);
                };
                
                // Gán sự kiện
                document.getElementById('submitPassword').onclick = confirmHandler;
                document.getElementById('cancelAuth').onclick = cancelHandler;
                
                // Xử lý nhấn phím Enter
                passwordInput.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        confirmHandler();
                    }
                };
            }
            
            // Thiết lập lắng nghe dữ liệu thời gian thực
            function setupRealtimeListener() {
                unsubscribe = db.collection('purchases').onSnapshot((snapshot) => {
                    purchaseData = {};
                    snapshot.forEach((doc) => {
                        purchaseData[doc.id] = doc.data();
                    });
                    
                    // Cập nhật giao diện sau khi đồng bộ
                    document.getElementById('viewDate').dispatchEvent(new Event('change'));
                    document.getElementById('monthSelector').dispatchEvent(new Event('change'));
                    
                    // Cập nhật trạng thái đồng bộ
                    document.getElementById('syncStatus').className = 'sync-status sync-online';
                    document.getElementById('syncMessage').textContent = 'Dữ liệu đã đồng bộ';
                }, (error) => {
                    console.error('Lỗi khi lắng nghe dữ liệu:', error);
                    document.getElementById('syncStatus').className = 'sync-status sync-offline';
                    document.getElementById('syncMessage').textContent = 'Mất kết nối, đang thử lại...';
                });
            }
            
            // Tính toán thành tiền khi số lượng hoặc đơn giá thay đổi
            function setupCalculation() {
                document.querySelectorAll('.food-item').forEach(item => {
                    const quantityInput = item.querySelector('input[placeholder*="Số lượng"]');
                    const priceInput = item.querySelector('input[placeholder*="Đơn giá"]');
                    const totalInput = item.querySelector('input[placeholder*="Thành tiền"]');
                    
                    if (quantityInput && priceInput && totalInput) {
                        const calculateTotal = () => {
                            const quantity = parseFloat(quantityInput.value) || 0;
                            const price = parseFloat(priceInput.value) || 0;
                            const total = quantity * price;
                            totalInput.value = formatCurrencyVND(total);
                        };
                        
                        quantityInput.addEventListener('input', calculateTotal);
                        priceInput.addEventListener('input', calculateTotal);
                    }
                });
            }

            // Hàm cập nhật các ô thống kê
            function updateStats(filteredData) {
                let totalDays = 0;
                let totalMeat = 0;
                let totalSeafood = 0;
                let totalAmount = 0;

                for (const data of Object.values(filteredData)) {
                    totalDays++;
                    
                    if (data.meat) {
                        for (const details of Object.values(data.meat)) {
                            // Chỉ tính những mặt hàng có quantity > 0
                            if (details.quantity > 0) {
                                totalMeat += details.quantity;
                                totalAmount += details.total || (details.quantity * details.price);
                            }
                        }
                    }
                    
                    if (data.seafood) {
                        for (const details of Object.values(data.seafood)) {
                            // Chỉ tính những mặt hàng có quantity > 0
                            if (details.quantity > 0) {
                                totalSeafood += details.quantity;
                                totalAmount += details.total || (details.quantity * details.price);
                            }
                        }
                    }
                }

                document.getElementById('totalDays').textContent = totalDays;
                document.getElementById('totalMeat').textContent = totalMeat.toFixed(2) + ' kg';
                document.getElementById('totalSeafood').textContent = totalSeafood.toFixed(2) + ' kg';
                document.getElementById('totalAmount').textContent = formatCurrencyVND(totalAmount) + ' VND';
            }
            
            // # BỔ SUNG: HÀM LƯU RIÊNG LẺ
            function collectAndSave(category) {
                const selectedDate = document.getElementById('selectedDate').value;
                if (!selectedDate) {
                    showNotification('Vui lòng chọn ngày!', false);
                    return;
                }
                
                let hasDataToSave = false;
                const itemsToSave = {};

                // Chọn đúng phần tử chứa các mục cần lưu
                const containerId = category === 'meat' ? '#meatItems' : '#seafoodItems';
                
                document.querySelectorAll(`${containerId} .food-item`).forEach(item => {
                    const nameInput = item.querySelector('input[data-name]');
                    const quantityInput = item.querySelector('input[placeholder*="Số lượng"]');
                    const priceInput = item.querySelector('input[placeholder*="Đơn giá"]');
                    
                    if (nameInput && quantityInput && priceInput) {
                        const quantity = parseFloat(quantityInput.value);
                        // Chỉ lưu những mục có số lượng > 0
                        if (quantity > 0) {
                            const name = nameInput.dataset.name || nameInput.value.trim(); 
                            const price = parseFloat(priceInput.value) || 0;
                            itemsToSave[name] = {
                                quantity: quantity,
                                price: price,
                                total: (quantity * price)
                            };
                            hasDataToSave = true;
                        }
                    }
                });

                if (!hasDataToSave) {
                    showNotification(`Không có dữ liệu số lượng > 0 để lưu trong mục ${category === 'meat' ? 'Thịt' : 'Hải sản'}!`, false);
                    return;
                }
                
                // Lưu dữ liệu lên Firebase. Sử dụng merge: true để chỉ cập nhật mục 'meat' hoặc 'seafood'
                db.collection('purchases').doc(selectedDate).set({
                    [category]: itemsToSave, // Sử dụng biến động [category]
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true })
                .then(() => {
                    showNotification(`Đã lưu dữ liệu ${category === 'meat' ? 'Thịt' : 'Hải sản'} cho ngày ${selectedDate}`);
                    
                    // Làm mới form (chỉ xóa input số lượng và đơn giá của mục đã lưu)
                    document.querySelectorAll(`${containerId} .food-item input[type="number"]`).forEach(input => {
                        input.value = '';
                    });
                    document.querySelectorAll(`${containerId} .food-item input[placeholder*="Thành tiền"]`).forEach(input => {
                        input.value = '';
                    });
                })
                .catch((error) => {
                    showNotification('Lỗi khi lưu dữ liệu: ' + error.message, false);
                });
            }
            // # KẾT THÚC BỔ SUNG: HÀM LƯU RIÊNG LẺ

            // Gán sự kiện cho các nút lưu mới
            document.getElementById('saveMeatData').addEventListener('click', function() {
                collectAndSave('meat');
            });

            document.getElementById('saveSeafoodData').addEventListener('click', function() {
                collectAndSave('seafood');
            });

            // Gỡ bỏ sự kiện cho nút saveData cũ (nếu nó không bị ẩn)

            // Xem dữ liệu theo ngày
            document.getElementById('viewDate').addEventListener('change', function() {
                const viewDate = this.value;
                const tableBody = document.querySelector('#dataTable tbody');
                tableBody.innerHTML = '';
                
                // Ẩn cột chỉnh sửa nếu không ở chế độ chỉnh sửa
                document.getElementById('editColumnHeader').style.display = isEditMode ? 'table-cell' : 'none';
                
                if (purchaseData[viewDate]) {
                    const data = purchaseData[viewDate];
                    let totalAmount = 0;
                    
                    const renderItems = (items) => {
                        for (const [item, details] of Object.entries(items)) {
                            // Sửa lỗi nếu details.total chưa được tính
                            const itemTotal = details.total || (details.quantity * details.price); 

                            if (details.quantity > 0) {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${item}</td>
                                    <td>${details.quantity} kg</td>
                                    <td>${formatCurrencyVND(details.price)}</td>
                                    <td>${formatCurrencyVND(itemTotal)}</td>
                                    ${isEditMode ? `<td>
                                        <button class="btn btn-sm btn-outline-primary edit-item" data-category="${items === data.meat ? 'meat' : 'seafood'}" data-item="${item}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>` : ''}
                                `;
                                tableBody.appendChild(row);
                                totalAmount += itemTotal;
                            }
                        }
                    }

                    // Hiển thị thịt
                    if (data.meat) renderItems(data.meat);
                    
                    // Hiển thị hải sản
                    if (data.seafood) renderItems(data.seafood);
                    
                    // Hiển thị tổng
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'total-row';
                    totalRow.innerHTML = `
                        <td colspan="${isEditMode ? '4' : '3'}"><strong>Tổng cộng</strong></td>
                        <td><strong>${formatCurrencyVND(totalAmount)} VND</strong></td>
                    `;
                    tableBody.appendChild(totalRow);
                    
                    // Hiển thị thông tin cập nhật
                    const infoRow = document.createElement('tr');
                    infoRow.innerHTML = `
                        <td colspan="${isEditMode ? '5' : '4'}" class="text-muted small">
                            Cập nhật lần cuối: 
                            ${data.updatedAt ? new Date(data.updatedAt.toDate()).toLocaleString('vi-VN') : 'N/A'}
                        </td>
                    `;
                    tableBody.appendChild(infoRow);
                    
                    // Thêm sự kiện cho các nút chỉnh sửa
                    if (isEditMode) {
                        document.querySelectorAll('.edit-item').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const category = this.dataset.category;
                                const itemName = this.dataset.item;
                                editItem(viewDate, category, itemName);
                            });
                        });
                    }
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="${isEditMode ? '5' : '4'}" class="text-center">Không có dữ liệu cho ngày này</td>
                    `;
                    tableBody.appendChild(row);
                }
            });
            
            // Chỉnh sửa mặt hàng
            function editItem(date, category, itemName) {
                const data = purchaseData[date];
                if (!data || !data[category] || !data[category][itemName]) return;
                
                const itemData = data[category][itemName];
                
                // Hiển thị modal chỉnh sửa
                const newQty = prompt(`Chỉnh sửa SỐ LƯỢNG (kg) cho "${itemName}":`, itemData.quantity);
                
                if (newQty !== null) {
                    const quantity = parseFloat(newQty);
                    if (isNaN(quantity) || quantity < 0) {
                        showNotification('Số lượng không hợp lệ!', false);
                        return;
                    }

                    const newPrice = prompt(`Chỉnh sửa ĐƠN GIÁ (VND) cho "${itemName}":`, itemData.price);
                    
                    if (newPrice !== null) {
                        const price = parseFloat(newPrice) || 0;
                        if (isNaN(price) || price < 0) {
                            showNotification('Đơn giá không hợp lệ!', false);
                            return;
                        }

                        // Cập nhật dữ liệu
                        db.collection('purchases').doc(date).set({
                            [category]: {
                                ...data[category],
                                [itemName]: {
                                    quantity: quantity,
                                    price: price,
                                    total: quantity * price // Tính lại tổng
                                }
                            },
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true })
                        .then(() => {
                            showNotification(`Đã cập nhật số lượng và đơn giá ${itemName}`);
                        })
                        .catch((error) => {
                            showNotification('Lỗi khi cập nhật: ' + error.message, false);
                        });
                    }
                }
            }
            
            // Kích hoạt xem dữ liệu ngày hiện tại
            document.getElementById('viewDate').dispatchEvent(new Event('change'));
            
            // Xóa dữ liệu theo ngày
            document.getElementById('deleteDate').addEventListener('click', function() {
                const viewDate = document.getElementById('viewDate').value;
                
                if (purchaseData[viewDate]) {
                    // Yêu cầu xác thực trước khi xóa
                    if (!isAuthenticated) {
                        showAuthModal(function(success) {
                            if (success) {
                                // Sau khi xác thực thành công, thực hiện xóa
                                if (confirm('Bạn có chắc chắn muốn xóa dữ liệu ngày ' + viewDate + '?')) {
                                    db.collection('purchases').doc(viewDate).delete()
                                        .then(() => {
                                            showNotification('Đã xóa dữ liệu ngày ' + viewDate);
                                        })
                                        .catch((error) => {
                                            showNotification('Lỗi khi xóa dữ liệu: ' + error.message, false);
                                        });
                                }
                            }
                        });
                    } else {
                        if (confirm('Bạn có chắc chắn muốn xóa dữ liệu ngày ' + viewDate + '?')) {
                            db.collection('purchases').doc(viewDate).delete()
                                .then(() => {
                                    showNotification('Đã xóa dữ liệu ngày ' + viewDate);
                                })
                                .catch((error) => {
                                    showNotification('Lỗi khi xóa dữ liệu: ' + error.message, false);
                                });
                        }
                    }
                } else {
                    showNotification('Không có dữ liệu để xóa cho ngày này', false);
                }
            });
            
            // Tính tổng
            document.getElementById('calculateTotal').addEventListener('click', function() {
                const viewDate = document.getElementById('viewDate').value;
                let totalMeat = 0;
                let totalSeafood = 0;
                let totalAmount = 0;
                
                if (purchaseData[viewDate]) {
                    const data = purchaseData[viewDate];
                    
                    if (data.meat) {
                        for (const details of Object.values(data.meat)) {
                            if (details.quantity > 0) {
                                totalMeat += details.quantity;
                                totalAmount += details.total || (details.quantity * details.price);
                            }
                        }
                    }
                    
                    if (data.seafood) {
                        for (const details of Object.values(data.seafood)) {
                            if (details.quantity > 0) {
                                totalSeafood += details.quantity;
                                totalAmount += details.total || (details.quantity * details.price);
                            }
                        }
                    }
                    
                    alert(`Tổng kết ngày ${viewDate}:
- Tổng lượng thịt: ${totalMeat.toFixed(2)} kg
- Tổng lượng hải sản: ${totalSeafood.toFixed(2)} kg
- Tổng tiền: ${formatCurrencyVND(totalAmount)} VND`);
                } else {
                    showNotification('Không có dữ liệu để tính tổng', false);
                }
            });
            
            // Chuyển đổi chế độ chỉnh sửa
            document.getElementById('toggleEditMode').addEventListener('click', function() {
                if (!isAuthenticated) {
                    showAuthModal(function(success) {
                        if (success) {
                            isEditMode = !isEditMode;
                            document.getElementById('toggleEditMode').innerHTML = 
                                isEditMode ? 
                                '<i class="fas fa-times me-2"></i>Thoát chỉnh sửa' : 
                                '<i class="fas fa-edit me-2"></i>Chỉnh sửa';
                            
                            // Cập nhật lại bảng
                            document.getElementById('viewDate').dispatchEvent(new Event('change'));
                        }
                    });
                } else {
                    isEditMode = !isEditMode;
                    document.getElementById('toggleEditMode').innerHTML = 
                        isEditMode ? 
                        '<i class="fas fa-times me-2"></i>Thoát chỉnh sửa' : 
                        '<i class="fas fa-edit me-2"></i>Chỉnh sửa';
                    
                    // Cập nhật lại bảng
                    document.getElementById('viewDate').dispatchEvent(new Event('change'));
                }
            });

            // Thiết lập thống kê tháng
            document.getElementById('monthSelector').addEventListener('change', function() {
                const month = this.value;
                if (!month) return;
                
                const startDate = month + '-01';
                // Lấy ngày cuối cùng của tháng
                const endDate = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]), 0).toISOString().split('T')[0];
                
                const filteredData = {};
                for (const [date, data] of Object.entries(purchaseData)) {
                    if (date >= startDate && date <= endDate) {
                        filteredData[date] = data;
                    }
                }
                
                updateStats(filteredData);
            });

            // Tính toán thống kê theo khoảng ngày mới
            document.getElementById('calculateDateRange').addEventListener('click', function() {
                const startDate = document.getElementById('startDateSelector').value;
                const endDate = document.getElementById('endDateSelector').value;
                
                if (!startDate || !endDate) {
                    showNotification('Vui lòng chọn cả Ngày bắt đầu và Ngày kết thúc!', false);
                    return;
                }
                
                if (startDate > endDate) {
                    showNotification('Ngày bắt đầu không thể lớn hơn Ngày kết thúc!', false);
                    return;
                }
                
                const filteredData = {};
                for (const [date, data] of Object.entries(purchaseData)) {
                    // Lọc dữ liệu trong khoảng [startDate, endDate]
                    if (date >= startDate && date <= endDate) {
                        filteredData[date] = data;
                    }
                }
                
                if (Object.keys(filteredData).length === 0) {
                    showNotification(`Không có dữ liệu trong khoảng từ ${startDate} đến ${endDate}`, false);
                    updateStats({}); 
                    return;
                }
                
                showNotification(`Đã tính tổng từ ngày ${startDate} đến ${endDate}`);
                updateStats(filteredData);
            });
            
            // # BỔ SUNG: XUẤT FILE EXCEL ĐA SHEET VÀ ĐỊNH DẠNG SỐ TIỀN
            document.getElementById('exportExcel').addEventListener('click', function() {
                const month = document.getElementById('monthSelector').value;
                const startDateRange = document.getElementById('startDateSelector').value;
                const endDateRange = document.getElementById('endDateSelector').value;

                let exportStartDate, exportEndDate;
                let exportName;
                let filteredData = {};

                // Ưu tiên thống kê theo khoảng ngày nếu có
                if (startDateRange && endDateRange) {
                    if (startDateRange > endDateRange) {
                        showNotification('Ngày bắt đầu không thể lớn hơn Ngày kết thúc!', false);
                        return;
                    }
                    exportStartDate = startDateRange;
                    exportEndDate = endDateRange;
                    exportName = `Khoang_ngay_${exportStartDate}_den_${exportEndDate}`;
                } 
                // Nếu không, xuất theo tháng
                else if (month) {
                    exportStartDate = month + '-01';
                    // Lấy ngày cuối cùng của tháng
                    exportEndDate = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]), 0).toISOString().split('T')[0];
                    exportName = `Thang_${month}`;
                } else {
                    showNotification('Vui lòng chọn Tháng hoặc Khoảng ngày để xuất Excel!', false);
                    return;
                }
                
                // Lọc dữ liệu
                for (const [date, data] of Object.entries(purchaseData)) {
                    if (date >= exportStartDate && date <= exportEndDate) {
                        filteredData[date] = data;
                    }
                }

                if (Object.keys(filteredData).length === 0) {
                    showNotification('Không có dữ liệu để xuất file Excel', false);
                    return;
                }
                
                // Chuẩn bị dữ liệu cho Excel (3 sheets)
                let wsDataTotal = [['Ngày', 'Tổng Chi Phí (VND)']];
                let wsDataMeat = [['Ngày', 'Mặt hàng', 'Số lượng (kg)', 'Đơn giá (VND)', 'Thành tiền (VND)']];
                let wsDataSeafood = [['Ngày', 'Mặt hàng', 'Số lượng (kg)', 'Đơn giá (VND)', 'Thành tiền (VND)']];
                
                for (const [date, data] of Object.entries(filteredData)) {
                    let dailyTotal = 0;
                    
                    const processItems = (items, sheetData) => {
                        for (const [item, details] of Object.entries(items)) {
                            if (details.quantity > 0) {
                                
                                const finalTotal = details.total || (details.quantity * details.price); 
                                dailyTotal += finalTotal;
                                sheetData.push([
                                    date,
                                    item,
                                    details.quantity,
                                    details.price,
                                    Math.round(finalTotal) // Tiền được làm tròn
                                ]);
                            }
                        }
                    }

                    if (data.meat) processItems(data.meat, wsDataMeat);
                    if (data.seafood) processItems(data.seafood, wsDataSeafood);
                    
                    // Thêm vào sheet Tổng Chi Phí
                    wsDataTotal.push([
                        date,
                        Math.round(dailyTotal)
                    ]);
                }
                
                // Tạo workbook
                const wb = XLSX.utils.book_new();
                
                // SHEET 1: TỔNG CHI PHÍ
                const wsTotal = XLSX.utils.aoa_to_sheet(wsDataTotal);
                XLSX.utils.book_append_sheet(wb, wsTotal, '01. Tong_Chi_Phi');
                
                // SHEET 2: THỊT
                const wsMeat = XLSX.utils.aoa_to_sheet(wsDataMeat);
                XLSX.utils.book_append_sheet(wb, wsMeat, '02. Chi_Tiet_Thit');
                
                // SHEET 3: HẢI SẢN
                const wsSeafood = XLSX.utils.aoa_to_sheet(wsDataSeafood);
                XLSX.utils.book_append_sheet(wb, wsSeafood, '03. Chi_Tiet_Hai_San');

                // Tùy chỉnh định dạng số tiền VND (200.000)
                const numberFormat = '#,##0'; 
                
                // Áp dụng định dạng cho các cột tiền tệ
                const applyNumberFormat = (ws, cols) => {
                    if (!ws['!ref']) return;
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for(let R = range.s.r + 1; R <= range.e.r; ++R) {
                        cols.forEach(C => {
                            const cell = ws[XLSX.utils.encode_cell({c: C, r: R})];
                            if(cell && cell.t === 'n') cell.z = numberFormat;
                        });
                    }
                };

                // Sheet 01. Tong_Chi_Phi: cột B (index 1)
                applyNumberFormat(wsTotal, [1]); 
                
                // Sheet 02. Chi_Tiet_Thit: cột D (index 3) và E (index 4)
                applyNumberFormat(wsMeat, [3, 4]);
                
                // Sheet 03. Chi_Tiet_Hai_San: cột D (index 3) và E (index 4)
                applyNumberFormat(wsSeafood, [3, 4]);
                
                // Xuất file
                XLSX.writeFile(wb, `Du_lieu_mua_hang_${exportName}.xlsx`);
                showNotification('Đã xuất file Excel thành công');
            });
            // # KẾT THÚC BỔ SUNG: XUẤT FILE EXCEL

            // Thêm mặt hàng thịt mới
            document.getElementById('addMeatBtn').addEventListener('click', function() {
                const nameInput = document.getElementById('otherMeatName');
                const qtyInput = document.getElementById('otherMeatQty');
                const priceInput = document.getElementById('otherMeatPrice');
                
                const name = nameInput.value.trim();
                const qty = parseFloat(qtyInput.value);
                const price = parseFloat(priceInput.value) || 0;
                
                if (!name || isNaN(qty) || qty <= 0) {
                    showNotification('Vui lòng nhập đầy đủ Tên mặt hàng và Số lượng > 0', false);
                    return;
                }
                
                const newItem = document.createElement('div');
                newItem.className = 'food-item';
                newItem.innerHTML = `
                    <label class="form-label">${name}</label>
                    <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="${name}" min="0" step="0.1" value="${qty}">
                    <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="${name}" min="0" value="${price}">
                    <input type="text" class="form-control" placeholder="Thành tiền" data-name="${name}" readonly value="${formatCurrencyVND(qty * price)}">
                `;
                
                // Thêm vào trước phần tử cuối cùng (Khác)
                document.getElementById('meatItems').insertBefore(newItem, document.getElementById('meatItems').lastElementChild);
                
                // Thiết lập tính toán cho mặt hàng mới
                const quantityInput = newItem.querySelector('input[placeholder*="Số lượng"]');
                const priceInputNew = newItem.querySelector('input[placeholder*="Đơn giá"]');
                const totalInput = newItem.querySelector('input[placeholder*="Thành tiền"]');
                
                const calculateTotal = () => {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInputNew.value) || 0;
                    totalInput.value = formatCurrencyVND(quantity * price);
                };
                
                quantityInput.addEventListener('input', calculateTotal);
                priceInputNew.addEventListener('input', calculateTotal);
                
                // Xóa dữ liệu đã nhập
                nameInput.value = '';
                qtyInput.value = '';
                priceInput.value = '';
                
                showNotification(`Đã thêm mặt hàng "${name}" vào danh sách thịt`);
            });
            
            // Thêm mặt hàng hải sản mới
            document.getElementById('addSeafoodBtn').addEventListener('click', function() {
                const nameInput = document.getElementById('otherSeafoodName');
                const qtyInput = document.getElementById('otherSeafoodQty');
                const priceInput = document.getElementById('otherSeafoodPrice');
                
                const name = nameInput.value.trim();
                const qty = parseFloat(qtyInput.value);
                const price = parseFloat(priceInput.value) || 0;
                
                if (!name || isNaN(qty) || qty <= 0) {
                    showNotification('Vui lòng nhập đầy đủ Tên mặt hàng và Số lượng > 0', false);
                    return;
                }
                
                const newItem = document.createElement('div');
                newItem.className = 'food-item';
                newItem.innerHTML = `
                    <label class="form-label">${name}</label>
                    <input type="number" class="form-control" placeholder="Số lượng (kg)" data-name="${name}" min="0" step="0.1" value="${qty}">
                    <input type="number" class="form-control price-input" placeholder="Đơn giá" data-name="${name}" min="0" value="${price}">
                    <input type="text" class="form-control" placeholder="Thành tiền" data-name="${name}" readonly value="${formatCurrencyVND(qty * price)}">
                `;
                
                // Thêm vào trước phần tử cuối cùng (Khác)
                document.getElementById('seafoodItems').insertBefore(newItem, document.getElementById('seafoodItems').lastElementChild);
                
                // Thiết lập tính toán cho mặt hàng mới
                const quantityInput = newItem.querySelector('input[placeholder*="Số lượng"]');
                const priceInputNew = newItem.querySelector('input[placeholder*="Đơn giá"]');
                const totalInput = newItem.querySelector('input[placeholder*="Thành tiền"]');
                
                const calculateTotal = () => {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInputNew.value) || 0;
                    totalInput.value = formatCurrencyVND(quantity * price);
                };
                
                quantityInput.addEventListener('input', calculateTotal);
                priceInputNew.addEventListener('input', calculateTotal);
                
                // Xóa dữ liệu đã nhập
                nameInput.value = '';
                qtyInput.value = '';
                priceInput.value = '';
                
                showNotification(`Đã thêm mặt hàng "${name}" vào danh sách hải sản`);
            });
            
            // Thiết lập tháng hiện tại và kích hoạt thống kê ban đầu
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('monthSelector').value = currentMonth;
            
            // Khởi tạo
            setupCalculation();
            setupRealtimeListener();
        });
    </script>
</body>
</html>