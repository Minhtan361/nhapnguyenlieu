<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Nguyên Liệu Hằng Ngày</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase App (core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Analytics -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .login-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .login-container h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .login-container input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .login-container button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        .login-container button:hover {
            background: #388E3C;
        }
        
        .login-message {
            margin-top: 15px;
            color: #e74c3c;
            font-weight: bold;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: none;
        }
        
        header {
            background: linear-gradient(90deg, #2c3e50 0%, #4ca1af 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .date-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .date-selector input, .date-selector button, .date-selector select {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .date-selector input, .date-selector select {
            border: 1px solid #ddd;
            width: 200px;
        }
        
        .date-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 15px;
            border-radius: 5px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-export {
            background: #2196F3;
        }
        
        .btn-export:hover {
            background: #1976D2;
        }
        
        .btn-view {
            background: #FF9800;
        }
        
        .btn-view:hover {
            background: #F57C00;
        }
        
        .btn-remove {
            background: #e74c3c;
            padding: 5px 10px;
            font-size: 0.9rem;
        }
        
        .btn-remove:hover {
            background: #c0392b;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 20px;
        }
        
        .section {
            flex: 1;
            min-width: 300px;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4ca1af;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            position: relative;
        }
        
        .item-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .item-name {
            min-width: 120px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        .item-weight, .item-price {
            width: 100px;
        }
        
        .item-total {
            width: 150px;
            font-weight: bold;
            color: #E91E63;
            background: #f9f9f9;
        }
        
        .total-section {
            font-weight: bold;
            margin-top: 15px;
            padding: 15px;
            background: #2c3e50;
            color: white;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        .custom-item-input {
            display: flex;
            margin-top: 15px;
            gap: 10px;
        }
        
        .custom-item-input input {
            flex: 1;
        }
        
        .history-panel {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
        
        .history-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-date {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .history-total {
            color: #E91E63;
            font-weight: bold;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        
        .calendar-day {
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            background: #f0f0f0;
            transition: all 0.2s;
        }
        
        .calendar-day.has-data {
            background: #4CAF50;
            color: white;
        }
        
        .calendar-day:hover {
            background: #2c3e50;
            color: white;
        }
        
        .calendar-header {
            grid-column: span 7;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .calendar-day-name {
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .month-summary {
            margin-top: 20px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            border-left: 5px solid #2196F3;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ccc;
        }
        
        .summary-total {
            font-weight: bold;
            font-size: 1.2rem;
            color: #E91E63;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #ccc;
        }
        
        .firebase-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            justify-content: center;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            display: inline-block;
        }
        
        .status-indicator.offline {
            background: #f44336;
        }
        
        .admin-only {
            display: none;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .date-selector {
                flex-direction: column;
            }
        }
    

    <div class="container" id="app-container">
        <header>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
            <h1><i class="fas fa-utensils"></i> QUẢN LÝ NGUYÊN LIỆU HẰNG NGÀY</h1>
            
            <div class="date-selector">
                <input type="date" id="selected-date" value="">
                <div class="date-display" id="current-date-display"></div>
                <button class="btn" onclick="saveData()"><i class="fas fa-save"></i> Lưu dữ liệu</button>
                <button class="btn btn-export admin-only" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Xuất Excel</button>
                <button class="btn btn-view" onclick="toggleHistory()"><i class="fas fa-history"></i> Xem lịch sử</button>
                <button class="btn btn-remove admin-only" onclick="deleteDateData()"><i class="fas fa-trash"></i> Xóa dữ liệu ngày</button>
            </div>
            
            <div class="firebase-status" id="firebase-status">
                <span class="status-indicator" id="firebase-status-indicator"></span>
                <span id="firebase-status-text">Đang kết nối...</span>
            </div>
        </header>
        
        <div class="content">
            <div class="section">
                <div class="section-title">
                    <span>THỊT</span>
                    <span id="meat-count">5 mục</span>
                </div>
                <div id="meat-items">
                    <!-- Các mục thịt sẽ được thêm ở đây bằng JavaScript -->
                </div>
                
                <div class="custom-item-input admin-only">
                    <input type="text" id="new-meat-item" placeholder="Tên nguyên liệu thịt mới">
                    <button class="btn" onclick="addCustomItem('meat')"><i class="fas fa-plus"></i> Thêm</button>
                </div>
                
                <div class="total-section" id="meat-total">Tổng giá trị thịt: 0 VNĐ</div>
            </div>
            
            <div class="section">
                <div class="section-title">
                    <span>HẢI SẢN</span>
                    <span id="seafood-count">8 mục</span>
                </div>
                <div id="seafood-items">
                    <!-- Các mục hải sản sẽ được thêm ở đây bằng JavaScript -->
                </div>
                
                <div class="custom-item-input admin-only">
                    <input type="text" id="new-seafood-item" placeholder="Tên nguyên liệu hải sản mới">
                    <button class="btn" onclick="addCustomItem('seafood')"><i class="fas fa-plus"></i> Thêm</button>
                </div>
                
                <div class="total-section" id="seafood-total">Tổng giá trị hải sản: 0 VNĐ</div>
            </div>
        </div>
        
        <div class="history-panel" id="history-panel" style="display: none;">
            <div class="section-title">
                <span>LỊCH SỬ NHẬP LIỆU THÁNG NÀY</span>
                <span id="history-count">0 ngày có dữ liệu</span>
            </div>
            
            <div class="date-selector">
                <select id="month-select" onchange="updateCalendar()">
                    <option value="0">Tháng 1</option>
                    <option value="1">Tháng 2</option>
                    <option value="2">Tháng 3</option>
                    <option value="3">Tháng 4</option>
                    <option value="4">Tháng 5</option>
                    <option value="5">Tháng 6</option>
                    <option value="6">Tháng 7</option>
                    <option value="7">Tháng 8</option>
                    <option value="8">Tháng 9</option>
                    <option value="9">Tháng 10</option>
                    <option value="10">Tháng 11</option>
                    <option value="11">Tháng 12</option>
                </select>
                <select id="year-select" onchange="updateCalendar()">
                    <!-- Năm sẽ được thêm bằng JavaScript -->
                </select>
                <button class="btn btn-export admin-only" onclick="exportMonthToExcel()"><i class="fas fa-file-excel"></i> Xuất tổng tháng</button>
            </div>
            
            <div class="calendar" id="calendar">
                <!-- Lịch sẽ được tạo bằng JavaScript -->
            </div>
            
            <div class="month-summary" id="month-summary">
                <h3>Tổng kết tháng</h3>
                <div class="summary-item">
                    <span>Tổng số ngày có dữ liệu:</span>
                    <span id="summary-days">0</span>
                </div>
                <div class="summary-item">
                    <span>Tổng giá trị thịt:</span>
                    <span id="summary-meat">0 VNĐ</span>
                </div>
                <div class="summary-item">
                    <span>Tổng giá trị hải sản:</span>
                    <span id="summary-seafood">0 VNĐ</span>
                </div>
                <div class="summary-total">
                    <span>Tổng giá trị:</span>
                    <span id="summary-total">0 VNĐ</span>
                </div>
            </div>
            
            <div class="section-title" style="margin-top: 20px;">
                <span>CHI TIẾT THEO NGÀY</span>
            </div>
            
            <div class="history-list" id="history-list">
                <!-- Lịch sử sẽ được thêm ở đây bằng JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - sử dụng thông tin từ Firebase Console của bạn
       const firebaseConfig = {
  apiKey: "AIzaSyBIqzq1vh-Kqb5bA9fPuOw4QU_l3zODmOY",
  authDomain: "nguyenlieu-45afc.firebaseapp.com",
  projectId: "nguyenlieu-45afc",
  storageBucket: "nguyenlieu-45afc.firebasestorage.app",
  messagingSenderId: "502474199189",
  appId: "1:502474199189:web:8c05b3f568283d903f8b9c",
  measurementId: "G-GTHW6WNG5V"
};

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const db = firebase.firestore();
        
        // Kiểm tra kết nối Firebase
        function setupFirebaseListeners() {
            firebase.firestore().enableNetwork()
                .then(() => {
                    document.getElementById('firebase-status-indicator').style.background = '#4CAF50';
                    document.getElementById('firebase-status-text').textContent = 'Đã kết nối Firebase';
                })
                .catch((error) => {
                    document.getElementById('firebase-status-indicator').style.background = '#f44336';
                    document.getElementById('firebase-status-text').textContent = 'Mất kết nối Firebase';
                    console.error('Firebase connection error:', error);
                });
                
            // Lắng nghe sự thay đổi trạng thái kết nối
            firebase.firestore().disableNetwork()
                .then(() => {
                    // Offline mode - sẽ xử lý sau
                });
        }

       
            
            // Xóa nút xóa cho các mục
            removeRemoveButtons();
        }
        
        // Thêm nút xóa cho các mục
        function addRemoveButtons() {
            // Thêm nút xóa cho các mục thịt
            const meatItems = document.getElementById('meat-items');
            const meatRows = meatItems.querySelectorAll('.item-row');
            meatRows.forEach((row, index) => {
                if (!row.querySelector('.btn-remove')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-remove';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    removeBtn.onclick = () => removeItem('meat', index);
                    row.appendChild(removeBtn);
                }
            });
            
            // Thêm nút xóa cho các mục hải sản
            const seafoodItems = document.getElementById('seafood-items');
            const seafoodRows = seafoodItems.querySelectorAll('.item-row');
            seafoodRows.forEach((row, index) => {
                if (!row.querySelector('.btn-remove')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-remove';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    removeBtn.onclick = () => removeItem('seafood', index);
                    row.appendChild(removeBtn);
                }
            });
        }
        
        // Xóa nút xóa cho các mục
        function removeRemoveButtons() {
            const removeButtons = document.querySelectorAll('.btn-remove');
            removeButtons.forEach(btn => {
                btn.remove();
            });
        }
        
        // Xóa một mục
        function removeItem(type, index) {
            if (!isAdmin) {
                alert('Bạn cần đăng nhập với quyền admin để thực hiện chức năng này');
                return;
            }
            
            if (confirm('Bạn có chắc chắn muốn xóa mục này?')) {
                if (type === 'meat') {
                    meatItems.splice(index, 1);
                } else {
                    seafoodItems.splice(index, 1);
                }
                
                saveItems();
                renderItems();
            }
        }
        
        // Danh sách nguyên liệu mặc định
        const defaultItems = {
            meat: ["Ba rọi", "Thịt bằm", "Thịt gà", "Sườn cay", "Khác"],
            seafood: ["Tôm", "Mực", "Bạch tuộc", "Sò huyết", "Cá", "Đậu hủ", "Bún", "Khác"]
        };
        
        // Lấy dữ liệu từ localStorage hoặc sử dụng mặc định
        let meatItems = JSON.parse(localStorage.getItem('meatItems')) || defaultItems.meat;
        let seafoodItems = JSON.parse(localStorage.getItem('seafoodItems')) || defaultItems.seafood;
        
        // Lưu dữ liệu vào localStorage
        function saveItems() {
            localStorage.setItem('meatItems', JSON.stringify(meatItems));
            localStorage.setItem('seafoodItems', JSON.stringify(seafoodItems));
            updateItemsCount();
        }
        
        // Cập nhật số lượng mục
        function updateItemsCount() {
            document.getElementById('meat-count').textContent = meatItems.length + " mục";
            document.getElementById('seafood-count').textContent = seafoodItems.length + " mục";
        }
        
        // Hiển thị các mục nhập liệu
        function renderItems() {
            renderItemSection('meat', meatItems);
            renderItemSection('seafood', seafoodItems);
            updateItemsCount();
            
            // Thêm nút xóa nếu là admin
            if (isAdmin) {
                addRemoveButtons();
            }
        }
        
        // Hiển thị một phần tử nhập liệu
        function renderItemSection(type, items) {
            const container = document.getElementById(`${type}-items`);
            container.innerHTML = '';
            
            items.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `
                    <div class="item-name">${item}:</div>
                    <input type="number" placeholder="Số kg" min="0" step="0.01" 
                           onchange="calculateItemTotal('${type}', ${index})" 
                           id="${type}-weight-${index}" class="item-weight">
                    <input type="number" placeholder="Giá tiền (VNĐ)" min="0" 
                           onchange="calculateItemTotal('${type}', ${index})" 
                           id="${type}-price-${index}" class="item-price">
                    <input type="text" placeholder="Tổng" readonly 
                           id="${type}-total-${index}" class="item-total">
                `;
                container.appendChild(row);
            });
        }
        
        // Tính tổng cho một mục
        function calculateItemTotal(type, index) {
            const weight = parseFloat(document.getElementById(`${type}-weight-${index}`).value) || 0;
            const price = parseFloat(document.getElementById(`${type}-price-${index}`).value) || 0;
            const total = weight * price;
            
            document.getElementById(`${type}-total-${index}`).value = total.toLocaleString('vi-VN') + ' VNĐ';
            calculateSectionTotal(type);
        }
        
        // Tính tổng cho cả phần
        function calculateSectionTotal(type) {
            const items = type === 'meat' ? meatItems : seafoodItems;
            let sectionTotal = 0;
            
            for (let i = 0; i < items.length; i++) {
                const weight = parseFloat(document.getElementById(`${type}-weight-${i}`).value) || 0;
                const price = parseFloat(document.getElementById(`${type}-price-${i}`).value) || 0;
                sectionTotal += weight * price;
            }
            
            document.getElementById(`${type}-total`).textContent = 
                `Tổng giá trị ${type === 'meat' ? 'thịt' : 'hải sản'}: ${sectionTotal.toLocaleString('vi-VN')} VNĐ`;
        }
        
        // Thêm mục mới vào danh sách
        function addCustomItem(type) {
            if (!isAdmin) {
                alert('Bạn cần đăng nhập với quyền admin để thực hiện chức năng này');
                return;
            }
            
            const inputElement = document.getElementById(`new-${type}-item`);
            const newItem = inputElement.value.trim();
            
            if (newItem) {
                if (type === 'meat') {
                    meatItems.push(newItem);
                } else {
                    seafoodItems.push(newItem);
                }
                
                saveItems();
                renderItems();
                inputElement.value = '';
            } else {
                alert('Vui lòng nhập tên nguyên liệu!');
            }
        }
        
        // Lưu dữ liệu theo ngày
        function saveData() {
            const selectedDate = document.getElementById('selected-date').value;
            if (!selectedDate) {
                alert('Vui lòng chọn ngày!');
                return;
            }
            
            const meatData = collectData('meat', meatItems);
            const seafoodData = collectData('seafood', seafoodItems);
            
            const dailyData = {
                date: selectedDate,
                meat: meatData,
                seafood: seafoodData,
                total: meatData.total + seafoodData.total
            };
            
            // Lưu vào localStorage
            const allData = JSON.parse(localStorage.getItem('dailyData')) || {};
            allData[selectedDate] = dailyData;
            localStorage.setItem('dailyData', JSON.stringify(allData));
            
            // Lưu vào Firebase nếu là admin
            if (isAdmin) {
                saveToFirebase(dailyData);
            }
            
            alert(`Đã lưu dữ liệu cho ngày ${selectedDate}`);
            updateCalendar();
        }
        
        // Lưu dữ liệu lên Firebase
        function saveToFirebase(dailyData) {
            db.collection("dailyData").doc(dailyData.date).set(dailyData)
                .then(() => {
                    console.log("Document successfully written to Firebase!");
                })
                .catch((error) => {
                    console.error("Error writing document to Firebase: ", error);
                    alert("Có lỗi khi lưu lên Firebase. Dữ liệu vẫn được lưu cục bộ.");
                });
        }
        
        // Tải dữ liệu từ Firebase
        function loadDataFromFirebase() {
            if (!isAdmin) return;
            
            db.collection("dailyData").get().then((querySnapshot) => {
                const allData = JSON.parse(localStorage.getItem('dailyData')) || {};
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allData[data.date] = data;
                });
                
                localStorage.setItem('dailyData', JSON.stringify(allData));
                console.log("Data loaded from Firebase successfully!");
                updateCalendar();
            }).catch((error) => {
                console.error("Error loading data from Firebase: ", error);
            });
        }
        
        // Xóa dữ liệu của một ngày
        function deleteDateData() {
            if (!isAdmin) {
                alert('Bạn cần đăng nhập với quyền admin để thực hiện chức năng này');
                return;
            }
            
            const selectedDate = document.getElementById('selected-date').value;
            if (!selectedDate) {
                alert('Vui lòng chọn ngày!');
                return;
            }
            
            if (confirm(`Bạn có chắc chắn muốn xóa dữ liệu của ngày ${selectedDate}?`)) {
                // Xóa từ localStorage
                const allData = JSON.parse(localStorage.getItem('dailyData')) || {};
                delete allData[selectedDate];
                localStorage.setItem('dailyData', JSON.stringify(allData));
                
                // Xóa từ Firebase
                db.collection("dailyData").doc(selectedDate).delete().then(() => {
                    console.log("Document successfully deleted from Firebase!");
                    alert(`Đã xóa dữ liệu của ngày ${selectedDate}`);
                    updateCalendar();
                }).catch((error) => {
                    console.error("Error removing document from Firebase: ", error);
                    alert("Có lỗi khi xóa dữ liệu từ Firebase. Dữ liệu đã được xóa cục bộ.");
                });
            }
        }
        
        // Thu thập dữ liệu từ form
        function collectData(type, items) {
            const data = [];
            let totalValue = 0;
            
            items.forEach((item, index) => {
                const weight = parseFloat(document.getElementById(`${type}-weight-${index}`).value) || 0;
                const price = parseFloat(document.getElementById(`${type}-price-${index}`).value) || 0;
                const total = weight * price;
                
                if (weight > 0 || price > 0) {
                    data.push({
                        "name": item,
                        "weight": weight,
                        "price": price,
                        "total": total
                    });
                    totalValue += total;
                }
            });
            
            return {
                "items": data,
                "total": totalValue
            };
        }
        
        // Xuất dữ liệu ra Excel
        function exportToExcel() {
            if (!isAdmin) {
                alert('Bạn cần đăng nhập với quyền admin để thực hiện chức năng này');
                return;
            }
            
            const selectedDate = document.getElementById('selected-date').value;
            if (!selectedDate) {
                alert('Vui lòng chọn ngày!');
                return;
            }
            
            // Thu thập dữ liệu
            const meatData = collectData('meat', meatItems);
            const seafoodData = collectData('seafood', seafoodItems);
            
            // Tạo workbook
            const wb = XLSX.utils.book_new();
            
            // Tạo worksheet cho thịt
            const meatWSData = [
                ["THỊT", "", "", ""],
                ["Nguyên liệu", "Số kg", "Giá tiền (VNĐ)", "Tổng (VNĐ)"]
            ];
            
            meatData.items.forEach(item => {
                meatWSData.push([item.name, item.weight, item.price, item.total]);
            });
            
            meatWSData.push(["TỔNG CỘNG", "", "", meatData.total]);
            
            const meatWS = XLSX.utils.aoa_to_sheet(meatWSData);
            XLSX.utils.book_append_sheet(wb, meatWS, "Thịt");
            
            // Tạo worksheet cho hải sản
            const seafoodWSData = [
                ["HẢI SẢN", "", "", ""],
                ["Nguyên liệu", "Số kg", "Giá tiền (VNĐ)", "Tổng (VNĐ)"]
            ];
            
            seafoodData.items.forEach(item => {
                seafoodWSData.push([item.name, item.weight, item.price, item.total]);
            });
            
            seafoodWSData.push(["TỔNG CỘNG", "", "", seafoodData.total]);
            
            const seafoodWS = XLSX.utils.aoa_to_sheet(seafoodWSData);
            XLSX.utils.book_append_sheet(wb, seafoodWS, "Hải sản");
            
            // Xuất file
            XLSX.writeFile(wb, `Nguyen_lieu_${selectedDate}.xlsx`);
        }
        
        // Xuất tổng tháng ra Excel
        function exportMonthToExcel() {
            if (!isAdmin) {
                alert('Bạn cần đăng nhập với quyền admin để thực hiện chức năng này');
                return;
            }
            
            const month = parseInt(document.getElementById('month-select').value);
            const year = parseInt(document.getElementById('year-select').value);
            
            // Lấy dữ liệu tháng
            const monthData = getMonthData(month, year);
            
            // Tạo workbook
            const wb = XLSX.utils.book_new();
            
            // Tạo worksheet tổng hợp
            const summaryWSData = [
                ["TỔNG HỢP NGUYÊN LIỆU THÁNG " + (month + 1) + "/" + year, "", "", ""],
                ["Ngày", "Tổng thịt (VNĐ)", "Tổng hải sản (VNĐ)", "Tổng cộng (VNĐ)"]
            ];
            
            let totalMeat = 0;
            let totalSeafood = 0;
            let overallTotal = 0;
            
            monthData.forEach(day => {
                summaryWSData.push([
                    day.date,
                    day.meatTotal,
                    day.seafoodTotal,
                    day.total
                ]);
                
                totalMeat += day.meatTotal;
                totalSeafood += day.seafoodTotal;
                overallTotal += day.total;
            });
            
            summaryWSData.push(["TỔNG THÁNG", totalMeat, totalSeafood, overallTotal]);
            
            const summaryWS = XLSX.utils.aoa_to_sheet(summaryWSData);
            XLSX.utils.book_append_sheet(wb, summaryWS, "Tổng hợp tháng");
            
            // Xuất file
            XLSX.writeFile(wb, `Tong_hop_nguyen_lieu_${month + 1}_${year}.xlsx`);
        }
        
        // Hiển/ẩn lịch sử
        function toggleHistory() {
            const historyPanel = document.getElementById('history-panel');
            if (historyPanel.style.display === 'none') {
                historyPanel.style.display = 'block';
                updateCalendar();
            } else {
                historyPanel.style.display = 'none';
            }
        }
        
        // Cập nhật lịch
        function updateCalendar() {
            const monthSelect = document.getElementById('month-select');
            const yearSelect = document.getElementById('year-select');
            
            const month = parseInt(monthSelect.value);
            const year = parseInt(yearSelect.value);
            
            // Cập nhật năm trong dropdown
            const currentYear = new Date().getFullYear();
            if (yearSelect.options.length === 0) {
                for (let y = currentYear - 5; y <= currentYear + 1; y++) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    option.selected = y === currentYear;
                    yearSelect.appendChild(option);
                }
            }
            
            // Lấy dữ liệu tháng
            const monthData = getMonthData(month, year);
            
            // Hiển thị lịch
            renderCalendar(month, year, monthData);
            
            // Hiển thị tổng kết tháng
            renderMonthSummary(monthData);
            
            // Hiển thị lịch sử chi tiết
            renderHistoryList(monthData);
        }
        
        // Lấy dữ liệu tháng
        function getMonthData(month, year) {
            const allData = JSON.parse(localStorage.getItem('dailyData')) || {};
            const monthData = [];
            
            for (const date in allData) {
                const dateObj = new Date(date);
                if (dateObj.getMonth() === month && dateObj.getFullYear() === year) {
                    const data = allData[date];
                    monthData.push({
                        date: date,
                        meatTotal: data.meat.total,
                        seafoodTotal: data.seafood.total,
                        total: data.total
                    });
                }
            }
            
            // Sắp xếp theo ngày
            monthData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            return monthData;
        }
        
        // Hiển thị lịch
        function renderCalendar(month, year, monthData) {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            // Tạo header cho lịch
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = `Tháng ${month + 1} năm ${year}`;
            calendarEl.appendChild(header);
            
            // Tên các ngày trong tuần
            const daysOfWeek = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
            daysOfWeek.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day-name';
                dayEl.textContent = day;
                calendarEl.appendChild(dayEl);
            });
            
            // Ngày đầu tiên của tháng
            const firstDay = new Date(year, month, 1);
            // Ngày cuối cùng của tháng
            const lastDay = new Date(year, month + 1, 0);
            
            // Xác định ngày bắt đầu (Chủ nhật đầu tiên)
            let startDate = new Date(firstDay);
            startDate.setDate(firstDay.getDate() - firstDay.getDay());
            
            // Tạo lịch
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                
                // Kiểm tra xem ngày này có trong tháng đang xem không
                if (currentDate.getMonth() === month && currentDate.getFullYear() === year) {
                    dayEl.textContent = currentDate.getDate();
                    
                    // Kiểm tra xem ngày này có dữ liệu không
                    const dateString = formatDate(currentDate);
                    const hasData = monthData.some(d => d.date === dateString);
                    
                    if (hasData) {
                        dayEl.classList.add('has-data');
                    }
                    
                    // Thêm sự kiện click để xem dữ liệu ngày
                    dayEl.onclick = () => {
                        document.getElementById('selected-date').value = dateString;
                        loadDateData(dateString);
                    };
                } else {
                    dayEl.style.visibility = 'hidden';
                }
                
                calendarEl.appendChild(dayEl);
            }
        }
        
        // Hiển thị tổng kết tháng
        function renderMonthSummary(monthData) {
            let daysWithData = 0;
            let totalMeat = 0;
            let totalSeafood = 0;
            let overallTotal = 0;
            
            monthData.forEach(day => {
                daysWithData++;
                totalMeat += day.meatTotal;
                totalSeafood += day.seafoodTotal;
                overallTotal += day.total;
            });
            
            document.getElementById('summary-days').textContent = daysWithData;
            document.getElementById('summary-meat').textContent = totalMeat.toLocaleString('vi-VN') + ' VNĐ';
            document.getElementById('summary-seafood').textContent = totalSeafood.toLocaleString('vi-VN') + ' VNĐ';
            document.getElementById('summary-total').textContent = overallTotal.toLocaleString('vi-VN') + ' VNĐ';
            document.getElementById('history-count').textContent = daysWithData + ' ngày có dữ liệu';
        }
        
        // Hiển thị lịch sử chi tiết
        function renderHistoryList(monthData) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            monthData.forEach(day => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <span class="history-date">${formatDisplayDate(day.date)}</span>
                    <span class="history-total">${day.total.toLocaleString('vi-VN')} VNĐ</span>
                `;
                
                // Thêm sự kiện click để xem dữ liệu ngày
                historyItem.onclick = () => {
                    document.getElementById('selected-date').value = day.date;
                    loadDateData(day.date);
                    document.getElementById('history-panel').style.display = 'none';
                };
                
                historyList.appendChild(historyItem);
            });
        }
        
        // Tải dữ liệu của một ngày cụ thể
        function loadDateData(date) {
            const allData = JSON.parse(localStorage.getItem('dailyData')) || {};
            const dailyData = allData[date];
            
            if (dailyData) {
                // Hiển thị dữ liệu thịt
                loadSectionData('meat', dailyData.meat.items);
                
                // Hiển thị dữ liệu hải sản
                loadSectionData('seafood', dailyData.seafood.items);
                
                // Cập nhật tổng
                calculateSectionTotal('meat');
                calculateSectionTotal('seafood');
            } else {
                // Xóa dữ liệu cũ nếu không tìm thấy
                clearSectionData('meat');
                clearSectionData('seafood');
            }
        }
        
        // Tải dữ liệu cho một phần
        function loadSectionData(type, items) {
            items.forEach(item => {
                // Tìm index của item
                const itemsArray = type === 'meat' ? meatItems : seafoodItems;
                const index = itemsArray.findIndex(i => i === item.name);
                
                if (index !== -1) {
                    document.getElementById(`${type}-weight-${index}`).value = item.weight;
                    document.getElementById(`${type}-price-${index}`).value = item.price;
                    document.getElementById(`${type}-total-${index}`).value = item.total.toLocaleString('vi-VN') + ' VNĐ';
                }
            });
        }
        
        // Xóa dữ liệu của một phần
        function clearSectionData(type) {
            const items = type === 'meat' ? meatItems : seafoodItems;
            
            for (let i = 0; i < items.length; i++) {
                document.getElementById(`${type}-weight-${i}`).value = '';
                document.getElementById(`${type}-price-${i}`).value = '';
                document.getElementById(`${type}-total-${i}`).value = '';
            }
        }
        
        // Định dạng ngày thành YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Định dạng ngày hiển thị DD/MM/YYYY
        function formatDisplayDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        // Khởi tạo ứng dụng
        function initApp() {
            // Đặt ngày mặc định là hôm nay
            const today = new Date();
            document.getElementById('selected-date').value = formatDate(today);
            document.getElementById('current-date-display').textContent = formatDisplayDate(formatDate(today));
            
            // Hiển thị các mục nhập liệu
            renderItems();
            
            // Ẩn tính năng admin nếu chưa đăng nhập
            if (!isAdmin) {
                hideAdminFeatures();
            }
            
            // Cập nhật dropdown tháng/năm
            const currentMonth = today.getMonth();
            document.getElementById('month-select').value = currentMonth;
        }
        
        // Chạy ứng dụng khi trang được tải
        window.onload = initApp;
    </script>
</body>
</html>

